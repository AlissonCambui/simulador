<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento de Minimercados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Chosen Palette: VendPerto Orange/Yellow -->
    <!-- Application Structure Plan: A single-page dashboard designed for operational efficiency. The structure prioritizes immediate insight with key metrics (stat cards) at the top. Below, an interactive task management section allows for filtering and direct status updates on individual 'task cards', which is more modern and usable than a spreadsheet table. A modal is used for structured data entry of new tasks. Finally, two dynamic charts are placed at the bottom to provide analytical insights into incident patterns and financial impact across locations. This structure was chosen to mirror a typical workflow: 1) See the overall status, 2) Identify and work on specific tasks, 3) Analyze trends. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Dashboard Metrics -> Goal: Inform (at a glance) -> Viz/Method: Stat Cards (HTML/CSS) -> Interaction: None, auto-updates -> Justification: Provides immediate, high-level summary of the workload and results.
        - Report Info: Main control table (all columns) -> Goal: Organize & Manage -> Viz/Method: Interactive Task Cards (HTML/CSS) -> Interaction: Filtering by status/condo, direct status updates via dropdowns -> Justification: A card-based layout is more responsive and less overwhelming than a wide table. Direct interaction reduces clicks and speeds up the workflow.
        - Report Info: Occurrences & Loss Value -> Goal: Compare & Analyze -> Viz/Method: Bar Charts (Chart.js/Canvas) -> Interaction: Tooltips on hover, updates based on filters -> Justification: Visualizing this data helps identify problematic locations quickly, a task that is difficult with a simple table.
        - Report Info: New Task Entry -> Goal: Standardize Input -> Viz/Method: Modal Form (HTML/CSS) -> Interaction: Form submission -> Justification: A dedicated form reduces data entry errors compared to typing directly into a spreadsheet row. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .details-content.hidden {
            display: none;
        }
        .toggle-details-btn svg {
            transition: transform 0.2s ease-in-out;
        }
        .toggle-details-btn.collapsed svg {
            transform: rotate(180deg);
        }
        .ocorrencia-item.editing .view-mode { display: none; }
        .ocorrencia-item:not(.editing) .edit-mode { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <!-- Logo Inserido -->
            <div class="text-4xl font-extrabold mb-2 tracking-tight" style="font-family: 'Arial Black', Arial, sans-serif;">
                <span style="color: #f26324;">vend</span><span style="color: #f7b41e;">Perto</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Painel de Monitoramento</h1>
            <p class="text-slate-600 mt-2">Controle de backups, análises e ocorrências de minimercados.</p>
        </header>

        <!-- Dashboard Resumo -->
        <section id="dashboard-resumo" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Solicitações Ativas</h3>
                <p id="total-solicitacoes" class="text-3xl font-bold text-orange-600 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Backups Pendentes</h3>
                <p id="backups-pendentes" class="text-3xl font-bold text-amber-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Análises Pendentes</h3>
                <p id="analises-pendentes" class="text-3xl font-bold text-red-500 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <h3 class="text-sm font-semibold text-slate-500">Ocorrências (Semana)</h3>
                <p id="total-ocorrencias-semana" class="text-3xl font-bold text-slate-700 mt-1">0</p>
            </div>
        </section>

        <!-- Produtividade Semanal -->
        <section id="weekly-productivity" class="mb-8">
             <div class="bg-white p-4 rounded-lg shadow-md text-center max-w-sm mx-auto">
                <h3 class="text-sm font-semibold text-slate-500">Produtividade Semanal (Ocorrências / Análise)</h3>
                <p id="produtividade-semanal" class="text-3xl font-bold text-emerald-600 mt-1">N/A</p>
                <p class="text-xs text-slate-400 mt-1">Média da semana atual</p>
            </div>
        </section>


        <!-- Controles e Filtros -->
        <section class="bg-white p-4 rounded-lg shadow-md mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-4 flex-grow">
                    <input type="text" id="filtro-condominio" placeholder="Filtrar por condomínio..." class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 flex-grow md:flex-grow-0">
                    <input type="date" id="filtro-data" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <input type="number" id="filtro-semana" placeholder="Semana de Trabalho (Ex: 43)" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 w-44">
                    <select id="filtro-backup" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">Status do Backup (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Não visualizar">Não visualizar</option>
                    </select>
                    <select id="filtro-analise" class="border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">Status da Análise (Todos)</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Análise">Em Análise</option>
                        <option value="Concluída">Concluída</option>
                        <option value="Não visualizar">Não visualizar</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="expand-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-300">Expandir Todos</button>
                        <button id="collapse-all-btn" class="text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded-md hover:bg-slate-300">Recolher Todos</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="priority-btn" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700 transition-colors w-full sm:w-auto flex-grow">
                        Prioridades
                    </button>
                    <button id="pdv-dashboard-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600 transition-colors w-full sm:w-auto flex-grow">
                        Painel do PDV
                    </button>
                    <button id="annual-report-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600 transition-colors w-full sm:w-auto flex-grow">
                        Análise Anual
                    </button>
                    <button id="period-analysis-btn" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700 transition-colors w-full sm:w-auto flex-grow">
                        Análise por Período
                    </button>
                    <button id="add-task-btn" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700 transition-colors w-full sm:w-auto flex-grow">
                        + Adicionar Análise
                    </button>
                </div>
            </div>
             <div class="flex flex-wrap gap-2 w-full sm:w-auto mt-4 justify-end">
                <div class="relative inline-block text-left" id="actions-menu-container">
                    <div>
                        <button type="button" id="actions-menu-btn" class="inline-flex justify-center w-full rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-100 focus:ring-orange-500" aria-haspopup="true" aria-expanded="true">
                            Ações
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
    
                    <div id="actions-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-20">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="actions-menu-btn">
                            <button id="planner-btn" class="w-full text-left font-semibold text-orange-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Planejar Semana</A-button>
                            <button id="bulk-add-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Importar da Planilha</button>
                            <button id="rename-condo-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Renomear Condomínio</button>
                            <button id="category-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Gerenciar Categorias</button>
                            <button id="archive-btn" class="w-full text-left text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Arquivar Análises</button>
                            <div class="border-t border-slate-100 my-1"></div>
                            <!-- <button id="backup-btn" class="w-full text-left text-green-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Fazer Backup</button> -->
                            <button id="restore-btn" class="w-full text-left text-orange-700 block px-4 py-2 text-sm hover:bg-slate-100" role="menuitem">Restaurar Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lista de Tarefas -->
        <main id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Cards de tarefas serão inseridos aqui -->
        </main>
        
        <!-- Seção de Gráficos -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold text-center mb-8 text-slate-800">Ocorrências da Semana (por Condomínio)</h2>
            <div class="flex justify-center">
                <div class="bg-white p-4 rounded-lg shadow-md w-full lg:w-1/2">
                     <h3 class="text-center font-semibold mb-4">Ocorrências por Condomínio (Semana Atual)</h3>
                     <div class="chart-container">
                        <canvas id="ocorrenciasChart"></canvas>
                     </div>
                </div>
            </div>
        </section>
    </div>
    
    <input type="file" id="restore-input" class="hidden" accept=".json">
    <!-- <input type="file" id="import-csv-input" class="hidden" accept=".csv"> --> <!-- REMOVIDO -->

    <!-- Modal de Prioridades -->
    <div id="priority-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Por Onde Começar? (Prioridades)</h2>
                <button id="priority-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <p class="text-slate-600 mb-6">Esta é uma lista sugerida de suas análises, priorizando condomínios com maior histórico de ocorrências e as datas mais antigas.</p>
            <div class="flex-grow overflow-y-auto">
                <ul id="priority-task-list" class="space-y-3">
                    <!-- Itens da lista de prioridades serão inseridos aqui -->
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Modal Planejador Semanal -->
    <div id="planner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Planejador Semanal Inteligente</h2>
            <form id="planner-form">
                <p class="text-sm text-slate-600 mb-4">O sistema analisou seu histórico e sugere focar nestes condomínios de maior risco. Selecione quais deseja adicionar ao seu planejamento.</p>
                 <div class="mb-4">
                    <label for="planner-week-number" class="block text-sm font-medium text-slate-700">Planejar para a Semana de Trabalho (Nº):</label>
                    <input type="number" id="planner-week-number" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required>
                </div>
                <div id="planner-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-md min-h-[200px] max-h-64 space-y-2">
                    <!-- Lista de sugestões será inserida aqui -->
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="planner-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Gerar Tarefas</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal Painel do PDV -->
    <div id="pdv-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Painel do PDV</h2>
                <button id="pdv-dashboard-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="mb-4">
                <label for="pdv-select" class="block text-sm font-medium text-slate-700">Selecione o Condomínio</label>
                <select id="pdv-select" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500"></select>
            </div>
            <div id="pdv-content" class="flex-grow overflow-y-auto hidden space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Total Análises (Histórico)</h3>
                        <p id="pdv-total-analises" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Total Ocorrências (Histórico)</h3>
                        <p id="pdv-total-ocorrencias" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                </section>
                <section class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="text-center font-semibold mb-4">Tendência de Ocorrências (Últimos 12 Meses)</h3>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="pdvTrendChart"></canvas>
                    </div>
                </section>
                <section>
                    <h3 class="font-semibold mb-2 text-lg">Histórico de Análises</h3>
                    <ul id="pdv-task-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></ul>
                </section>
            </div>
        </div>
    </div>
    
    <!-- Modal de Arquivamento -->
    <div id="archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Arquivar Análises Concluídas</h2>
            <form id="archive-form">
                <p class="text-slate-600 mb-4">Selecione o período para arquivar análises concluídas. Isso irá removê-las da tela principal, mas elas não serão excluídas.</p>
                <div class="space-y-2 mb-6">
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-orange-50 has-[:checked]:border-orange-300">
                        <input type="radio" name="archive_period" value="7" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 1 semana</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-orange-50 has-[:checked]:border-orange-300">
                        <input type="radio" name="archive_period" value="30" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" checked>
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 1 mês</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-orange-50 has-[:checked]:border-orange-300">
                        <input type="radio" name="archive_period" value="90" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                        <span class="ml-3 text-sm font-medium text-slate-700">Mais antigas que 3 meses</span>
                    </label>
                </div>
                <div class="flex justify-between items-center gap-3">
                    <button type="button" id="view-archive-btn" class="bg-slate-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-slate-600">Ver Arquivadas</button>
                    <div class="flex gap-3">
                        <button type="button" id="archive-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Arquivar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Visualizar Arquivadas -->
    <div id="view-archive-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análises Arquivadas</h2>
                <button id="view-archive-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
             <div class="mb-4">
                <input type="text" id="archive-search-input" placeholder="Buscar em arquivadas por condomínio..." class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            <div id="view-archive-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-md min-h-[200px]">
                <p class="text-center text-slate-500">Nenhuma análise arquivada.</p>
            </div>
            <div class="mt-4 text-right">
                 <button id="unarchive-selected-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Desarquivar Selecionadas</button>
            </div>
        </div>
    </div>


    <!-- Modal para Análise por Período -->
    <div id="period-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Análise por Período</h2>
                <button id="period-analysis-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4 mb-4">
                <div>
                    <label for="period-start-date" class="block text-sm font-medium text-slate-700">Data de Início</label>
                    <input type="date" id="period-start-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div>
                    <label for="period-end-date" class="block text-sm font-medium text-slate-700">Data de Fim</label>
                    <input type="date" id="period-end-date" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                <div class="flex items-end">
                    <button id="generate-report-btn" class="bg-orange-600 text-white font-semibold w-full px-4 py-2 rounded-md hover:bg-orange-700">Gerar Relatório</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">Analisar por:</label>
                <div class="flex gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataAnalise" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" checked>
                        <span class="ml-2 text-sm text-slate-700">Data da Análise</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="analysis_type" value="dataConclusao" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500">
                        <span class="ml-2 text-sm text-slate-700">Data da Conclusão</span>
                    </label>
                </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
                <button data-period="this-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Esta Semana</button>
                <button data-period="last-week" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Semana Passada</button>
                <button data-period="this-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Este Mês</button>
                <button data-period="last-month" class="period-btn text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded-md hover:bg-slate-300">Mês Passado</button>
            </div>

            <div id="period-results-content" class="flex-grow overflow-y-auto hidden">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Dias (Análises)</h3>
                        <p id="period-dias" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">PDV (Condomínios)</h3>
                        <p id="period-pdv" class="text-3xl font-bold text-orange-500 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">OC (Ocorrências)</h3>
                        <p id="period-oc" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="text-center font-semibold mb-4">Ocorrências por Categoria</h3>
                        <div class="chart-container" style="height: 250px; max-height: 250px;">
                            <canvas id="periodCategoryChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-center font-semibold">Ocorrências por Condomínio (no Período)</h3>
                            <select id="period-category-filter" class="border border-slate-300 rounded-md px-2 py-1 text-xs focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="">Filtrar Categoria</option>
                            </select>
                        </div>
                        <div class="chart-container" style="height: 250px; max-height: 250px;">
                            <canvas id="periodChart"></canvas>
                        </div>
                    </div>
                </div>
                 <div class="mt-6">
                    <h3 class="font-semibold mb-2 text-lg">Lista de Análises no Período</h3>
                    <ul id="period-task-list" class="space-y-2 max-h-40 overflow-y-auto pr-2 bg-slate-50 p-2 rounded-md"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Análise Anual -->
    <div id="annual-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="annual-report-title">Análise Anual (2025)</h2>
                <button id="annual-report-close-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Total de Análises Concluídas (Ano)</h3>
                        <p id="annual-total-analises" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-slate-100 p-4 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-slate-500">Total de Ocorrências (Ano)</h3>
                        <p id="annual-total-ocorrencias" class="text-3xl font-bold text-red-600 mt-1">0</p>
                    </div>
                </section>
                <section class="bg-slate-50 p-4 rounded-lg">
                    <h3 class="text-center font-semibold mb-4">Ocorrências por Mês</h3>
                    <div class="chart-container" style="height: 250px; max-height: 250px;">
                        <canvas id="annualReportChart_Monthly"></canvas>
                    </div>
                </section>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="text-center font-semibold mb-4">Ocorrências por Categoria (Ano)</h3>
                        <div class="chart-container" style="height: 300px; max-height: 300px;">
                            <canvas id="annualReportChart_Category"></canvas>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <h3 class="text-center font-semibold mb-4">Top 10 Condomínios (Ocorrências no Ano)</h3>
                        <div class="chart-container" style="height: 300px; max-height: 300px;">
                            <canvas id="annualReportChart_Condo"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Tarefa -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Adicionar Nova Análise</h2>
            <form id="task-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="form-condominio" class="block text-sm font-medium text-slate-700">Condomínio</label>
                        <div class="relative">
                            <input type="text" id="form-condominio" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required autocomplete="off">
                            <div id="autocomplete-list" class="absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden max-h-40 overflow-y-auto shadow-lg"></div>
                        </div>
                    </div>
                    <div>
                        <label for="form-data-analise" class="block text-sm font-medium text-slate-700">Data para Análise</label>
                        <input type="date" id="form-data-analise" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="form-semana-trabalho" class="block text-sm font-medium text-slate-700">Semana de Trabalho (Nº)</label>
                    <input type="number" id="form-semana-trabalho" placeholder="Ex: 44" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                </div>
                 <div class="mt-4">
                    <label for="form-observacoes" class="block text-sm font-medium text-slate-700">Observações</label>
                    <textarea id="form-observacoes" rows="3" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Salvar</button>

                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Adicionar em Lote -->
    <div id="bulk-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Importar Análises da Planilha</h2>
            <form id="bulk-add-form">
                <div class="text-sm text-slate-600 space-y-3 mb-6">
                     <p>Copie os dados da sua planilha (incluindo a linha de cabeçalho) e cole no campo abaixo.</p>
                     <ol class="list-decimal list-inside space-y-2 pl-4">
                         <li>Garanta que sua planilha tenha as colunas: `Semana`, `Dia a visualizar`, `Unidade`, `Status` e `OC`.</li>
                         <li>Copie os dados (Ctrl+C), incluindo a linha de cabeçalho.</li>
                         <li>Cole os dados (Ctrl+V) na área de texto e clique em "Importar".</li>
                     </ol>
                     <p class="text-xs text-slate-500 mt-2"><strong>Obs:</strong> Tarefas `Finalizado` com `OC > 0` serão arquivadas. Tarefas `Pendente` serão adicionadas ao painel. Duplicatas serão ignoradas.</p>
                </div>
                <div>
                    <label for="bulk-input-area" class="block text-sm font-medium text-slate-700">Cole os dados da planilha aqui (com cabeçalho):</label>
                    <textarea id="bulk-input-area" rows="10" class="mt-1 w-full border border-slate-300 rounded-md shadow-sm p-2 focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="bulk-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Importar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Detalhes da Ocorrência -->
    <div id="ocorrencia-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Registrar Detalhes da Ocorrência</h2>
            <form id="ocorrencia-form" class="flex-grow flex flex-col min-h-0">
                <input type="hidden" id="ocorrencia-task-id">
                <div id="ocorrencia-list" class="flex-grow overflow-y-auto pr-2 -mr-2 mb-4 space-y-3"></div>
                <div class="flex-shrink-0 pt-4 border-t">
                    <h3 class="font-semibold mb-2">Adicionar Nova Ocorrência</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="add-ocorrencia-categoria" class="block text-sm font-medium text-slate-700">Categoria</label>
                            <select id="add-ocorrencia-categoria" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500"></select>
                        </div>
                        <div class="md:col-span-1">
                           <label for="add-ocorrencia-desc" class="block text-sm font-medium text-slate-700">Descrição</label>
                           <textarea id="add-ocorrencia-desc" rows="2" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                        <div>
                            <label for="add-horario-inicial" class="block text-sm font-medium text-slate-700">Horário Inicial</label>
                            <input type="time" id="add-horario-inicial" step="1" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label for="add-horario-final" class="block text-sm font-medium text-slate-700">Horário Final</label>
                            <input type="time" id="add-horario-final" step="1" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                     <div class="mt-3">
                        <label class="flex items-center">
                            <input type="checkbox" id="add-ocorrencia-inconclusiva" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                            <span class="ml-2 text-sm font-medium text-slate-700">Marcar como Inconclusiva</span>
                        </label>
                    </div>
                     <button type="button" id="add-ocorrencia-btn" class="mt-3 w-full bg-orange-100 text-orange-800 font-semibold px-4 py-2 rounded-md hover:bg-orange-200">+ Adicionar à Lista</button>
                </div>
                <div class="mt-6 flex justify-end gap-3 flex-shrink-0">
                    <button type="button" id="ocorrencia-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Salvar Ocorrências</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Gerenciar Categorias -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Categorias</h2>
            <form id="add-category-form" class="flex gap-2 mb-4">
                <input type="text" id="new-category-name" placeholder="Nova categoria..." class="flex-grow border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required>
                <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Adicionar</button>
            </form>
            <div id="category-list-container" class="flex-grow overflow-y-auto bg-slate-50 p-3 rounded-md min-h-[150px]">
                <!-- Lista de categorias será inserida aqui -->
            </div>
             <div class="mt-6 text-right">
                <button type="button" id="category-close-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Fechar</button>
            </div>
        </div>
    </div>


    <!-- Modal para Renomear Condomínio -->
    <div id="rename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-10">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Renomear Condomínio</h2>
            <form id="rename-form">
                <div class="space-y-4">
                    <div>
                        <label for="form-old-name" class="block text-sm font-medium text-slate-700">Nome Antigo do Condomínio</label>
                        <select id="form-old-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required></select>
                    </div>
                    <div>
                        <label for="form-new-name" class="block text-sm font-medium text-slate-700">Novo Nome do Condomínio</label>
                        <input type="text" id="form-new-name" class="mt-1 block w-full border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="rename-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="bg-orange-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-700">Salvar Alteração</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Confirmação de Restauração -->
    <div id="restore-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4 text-orange-600">Atenção!</h2>
            <p class="text-slate-600">Restaurar um backup irá <strong>substituir todos os dados atuais</strong>. Esta ação não pode ser desfeita. Deseja continuar?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="restore-confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-md hover:bg-slate-300">Cancelar</button>
                <button type="button" id="restore-confirm-proceed-btn" class="bg-orange-500 text-white font-semibold px-4 py-2 rounded-md hover:bg-orange-600">Sim, Restaurar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Notificação Genérica -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="text-slate-700 text-lg"></p>
            <button id="notification-close-btn" class="mt-6 bg-orange-600 text-white font-semibold px-6 py-2 rounded-md hover:bg-orange-700">OK</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let tasks = JSON.parse(localStorage.getItem('monitoramentoTasks')) || [];
            let archivedTasks = JSON.parse(localStorage.getItem('archivedTasks')) || [];
            let categories = JSON.parse(localStorage.getItem('monitoramentoCategorias')) || ['Furto', 'Fraude Pagamento', 'Consumo Indevido', 'Vandalismo', 'Outros'];

            tasks.forEach(t => {
                if (t.isExpanded === undefined) {
                    t.isExpanded = true;
                }
            });

            const taskList = document.getElementById('task-list');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const formCondominioInput = document.getElementById('form-condominio');
            const autocompleteList = document.getElementById('autocomplete-list');
            
            const bulkAddBtn = document.getElementById('bulk-add-btn');
            const bulkAddModal = document.getElementById('bulk-add-modal');
            const bulkAddForm = document.getElementById('bulk-add-form');
            const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
            const bulkInputArea = document.getElementById('bulk-input-area');

            const ocorrenciaModal = document.getElementById('ocorrencia-modal');
            const ocorrenciaForm = document.getElementById('ocorrencia-form');
            const ocorrenciaCancelBtn = document.getElementById('ocorrencia-cancel-btn');
            const ocorrenciaListDiv = document.getElementById('ocorrencia-list');
            const addOcorrenciaBtn = document.getElementById('add-ocorrencia-btn');
            const addOcorrenciaCategoriaSelect = document.getElementById('add-ocorrencia-categoria');
            const addOcorrenciaInconclusiva = document.getElementById('add-ocorrencia-inconclusiva');

            const renameCondoBtn = document.getElementById('rename-condo-btn');
            const renameModal = document.getElementById('rename-modal');
            const renameForm = document.getElementById('rename-form');
            const renameCancelBtn = document.getElementById('rename-cancel-btn');
            const oldNameSelect = document.getElementById('form-old-name');
            const newNameInput = document.getElementById('form-new-name');

            const filtroCondominio = document.getElementById('filtro-condominio');
            const filtroData = document.getElementById('filtro-data');
            const filtroSemana = document.getElementById('filtro-semana');
            const filtroBackup = document.getElementById('filtro-backup');
            const filtroAnalise = document.getElementById('filtro-analise');

            const expandAllBtn = document.getElementById('expand-all-btn');
            const collapseAllBtn = document.getElementById('collapse-all-btn');
            
            //const backupBtn = document.getElementById('backup-btn'); // No longer needed for manual action
            const restoreBtn = document.getElementById('restore-btn');
            const restoreInput = document.getElementById('restore-input');
            const restoreConfirmModal = document.getElementById('restore-confirm-modal');
            const restoreConfirmCancelBtn = document.getElementById('restore-confirm-cancel-btn');
            const restoreConfirmProceedBtn = document.getElementById('restore-confirm-proceed-btn');
            let fileToRestore = null;
            
            // REMOVIDO INÍCIO
            // const importCsvBtn = document.getElementById('import-csv-btn'); 
            // const importCsvModal = document.getElementById('import-csv-modal');
            // const importCsvCancelBtn = document.getElementById('import-csv-cancel-btn');
            // const importCsvSelectBtn = document.getElementById('import-csv-select-btn');
            // const importCsvInput = document.getElementById('import-csv-input');
            // REMOVIDO FIM


            const notificationModal = document.getElementById('notification-modal');
            const notificationMessage = document.getElementById('notification-message');
            const notificationCloseBtn = document.getElementById('notification-close-btn');

            const periodAnalysisBtn = document.getElementById('period-analysis-btn');
            const periodAnalysisModal = document.getElementById('period-analysis-modal');
            const periodAnalysisCloseBtn = document.getElementById('period-analysis-close-btn');
            const periodStartDateInput = document.getElementById('period-start-date');
            const periodEndDateInput = document.getElementById('period-end-date');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const periodResultsContent = document.getElementById('period-results-content');
            const periodTaskList = document.getElementById('period-task-list');
            const periodCategoryFilter = document.getElementById('period-category-filter');

            const priorityBtn = document.getElementById('priority-btn');
            const priorityModal = document.getElementById('priority-modal');
            const priorityCloseBtn = document.getElementById('priority-close-btn');
            const priorityTaskList = document.getElementById('priority-task-list');

            const pdvDashboardBtn = document.getElementById('pdv-dashboard-btn');
            const pdvDashboardModal = document.getElementById('pdv-dashboard-modal');
            const pdvDashboardCloseBtn = document.getElementById('pdv-dashboard-close-btn');
            const pdvSelect = document.getElementById('pdv-select');
            const pdvContent = document.getElementById('pdv-content');

            const plannerBtn = document.getElementById('planner-btn');
            const plannerModal = document.getElementById('planner-modal');
            const plannerCancelBtn = document.getElementById('planner-cancel-btn');
            const plannerForm = document.getElementById('planner-form');
            const plannerWeekNumberInput = document.getElementById('planner-week-number');
            const plannerListContainer = document.getElementById('planner-list-container');
            
            const categoryBtn = document.getElementById('category-btn');
            const categoryModal = document.getElementById('category-modal');
            const categoryCloseBtn = document.getElementById('category-close-btn');
            const addCategoryForm = document.getElementById('add-category-form');
            const newCategoryNameInput = document.getElementById('new-category-name');
            const categoryListContainer = document.getElementById('category-list-container');
            
            const archiveBtn = document.getElementById('archive-btn');
            const archiveModal = document.getElementById('archive-modal');
            const archiveForm = document.getElementById('archive-form');
            const archiveCancelBtn = document.getElementById('archive-cancel-btn');
            const viewArchiveBtn = document.getElementById('view-archive-btn');
            const viewArchiveModal = document.getElementById('view-archive-modal');
            const viewArchiveCloseBtn = document.getElementById('view-archive-close-btn');
            const viewArchiveListContainer = document.getElementById('view-archive-list-container');
            const unarchiveSelectedBtn = document.getElementById('unarchive-selected-btn');
            const archiveSearchInput = document.getElementById('archive-search-input');
            
            const annualReportBtn = document.getElementById('annual-report-btn');
            const annualReportModal = document.getElementById('annual-report-modal');
            const annualReportCloseBtn = document.getElementById('annual-report-close-btn');

            const actionsMenuContainer = document.getElementById('actions-menu-container');
            const actionsMenuBtn = document.getElementById('actions-menu-btn');
            const actionsMenu = document.getElementById('actions-menu');

            let ocorrenciasChart;
            let periodChart;
            let periodCategoryChart;
            let pdvTrendChart;
            let annualMonthlyChart, annualCategoryChart, annualCondoChart;

            const saveTasks = () => {
                localStorage.setItem('monitoramentoTasks', JSON.stringify(tasks));
                localStorage.setItem('archivedTasks', JSON.stringify(archivedTasks));
            };
            
            const saveCategories = () => {
                localStorage.setItem('monitoramentoCategorias', JSON.stringify(categories));
            };

            const showNotification = (message) => {
                notificationMessage.textContent = message;
                notificationModal.classList.remove('hidden');
            };

            notificationCloseBtn.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });
            
            const statusClasses = {
                Pendente: 'bg-amber-100 text-amber-800', 'Em Andamento': 'bg-orange-100 text-orange-800', Concluído: 'bg-emerald-100 text-emerald-800',
                'Em Análise': 'bg-orange-100 text-orange-800', Concluída: 'bg-emerald-100 text-emerald-800',
                'Não visualizar': 'bg-slate-200 text-slate-700',
            };

            const formatDate = (dateString, options = {}) => {
                if (!dateString) return 'N/A';
                const date = new Date(dateString + 'T00:00:00'); // Ensure correct timezone interpretation
                return date.toLocaleDateString('pt-BR', options);
            };
            
            const formatDateForInput = (date) => {
                 return date.toISOString().split('T')[0];
            };

            // Function to get ISO week number (Monday as the first day)
            const getWeekNumber = (d) => {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); // Adjust to make Monday day 1
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return weekNo;
            };
            
             // Function to get the date of the Monday of a given ISO week number and year
            const getDateOfISOWeek = (w, y) => {
                var simple = new Date(y, 0, 1 + (w - 1) * 7);
                var dow = simple.getDay();
                var ISOweekStart = simple;
                if (dow <= 4) { // 1(Mon) - 4(Thu)
                    ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                } else { // 5(Fri) - 0(Sun)
                    ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
                }
                return ISOweekStart;
            }


            const renderTasks = () => {
                 const currentWeekFilter = filtroSemana.value ? parseInt(filtroSemana.value) : null;
                const filteredTasks = tasks.filter(task => {
                    const matchCondominio = task.condominio.toLowerCase().includes(filtroCondominio.value.toLowerCase());
                    const matchData = !filtroData.value || task.dataAnalise === filtroData.value;
                    const matchBackup = !filtroBackup.value || task.statusBackup === filtroBackup.value;
                    const matchAnalise = !filtroAnalise.value || task.statusAnalise === filtroAnalise.value;
                    
                    // Match by EITHER specific date OR week, not both
                    let matchSemana = !currentWeekFilter; // True if no week filter
                    if (currentWeekFilter && !filtroData.value) { // Only apply week filter if date filter is not set
                        matchSemana = (task.semanaDeTrabalho === currentWeekFilter); 
                    }
                    
                    // If date is set, it overrides week filter
                    if (filtroData.value) {
                        matchSemana = true; // Ignore week filter if date is set
                    }

                    return matchCondominio && matchData && matchBackup && matchAnalise && matchSemana;
                });

                taskList.innerHTML = '';
                if(filteredTasks.length === 0) {
                    taskList.innerHTML = `<p class="text-slate-500 text-center col-span-full">Nenhuma tarefa encontrada.</p>`;
                } else {
                    filteredTasks.forEach(task => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow-md border-l-4';
                        card.style.borderColor = task.statusAnalise === 'Pendente' ? '#f59e0b' : (task.statusAnalise === 'Em Análise' ? '#f97316' : '#10b981');
                        
                        const isCollapsed = !task.isExpanded;

                        let ocorrenciaDetailsHTML = '';
                        if (task.ocorrencia === 'Sim' && task.ocorrencias && task.ocorrencias.length > 0) {
                           ocorrenciaDetailsHTML += `<div class="mt-4 pt-3 border-t border-slate-200 space-y-2">`;
                           task.ocorrencias.forEach(ocor => {
                               const inconclusivaBadge = ocor.isInconclusiva ? `<span class="text-xs font-semibold text-white bg-slate-400 px-2 py-0.5 rounded-full ml-2">Inconclusiva</span>` : '';
                               ocorrenciaDetailsHTML += `
                                <div class="p-2 bg-red-50 rounded-md">
                                    <p class="text-sm font-semibold text-red-800">${ocor.categoria || 'Sem Categoria'}</p>
                                    <p class="text-sm text-red-700">${ocor.desc}</p>
                                    <div class="flex items-center mt-1">
                                        <p class="text-xs text-red-600"><strong>Horário:</strong> ${ocor.horarioInicial || 'N/A'} - ${ocor.horarioFinal || 'N/A'}</p>
                                        ${inconclusivaBadge}
                                    </div>
                                </div>
                               `;
                           });
                           ocorrenciaDetailsHTML += `</div>`;
                        }
                        
                        let detailsButtonHTML = '';
                        if (task.statusAnalise === 'Em Análise') {
                             detailsButtonHTML = `<button data-id="${task.id}" class="edit-ocorrencia-btn mt-4 w-full text-sm bg-slate-200 text-slate-700 font-semibold py-2 rounded-md hover:bg-slate-300 transition-colors">Registrar Ocorrências</button>`;
                        }

                        let occurrenceCountHTML = '';
                        let completionDateHTML = '';
                        if (task.statusAnalise === 'Concluída') {
                            const count = task.ocorrencias ? task.ocorrencias.length : 0;
                            occurrenceCountHTML = `<div class="mt-2 text-sm font-bold ${count > 0 ? 'text-red-600' : 'text-emerald-600'}">Ocorrências: ${count}</div>`;
                            if (task.dataConclusao) {
                                completionDateHTML = `<div class="text-xs text-emerald-600 font-medium mt-1">Concluído em: ${formatDate(task.dataConclusao)}</div>`;
                            }
                        }


                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg text-slate-800 flex-1 pr-2">${task.condominio}</h3>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${task.ocorrencia === 'Sim' ? 'bg-red-100 text-red-800' : (task.ocorrencia === 'Não' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-500')}">${task.ocorrencia || 'Pendente'}</span>
                                    <button data-id="${task.id}" class="archive-single-btn text-slate-400 hover:text-orange-600 font-bold text-lg leading-none flex-shrink-0" title="Arquivar esta análise">&#128450;</button>
                                    <button data-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-600 font-bold text-xl leading-none flex-shrink-0" title="Excluir esta análise">&times;</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-sm text-slate-500">Analisar data: <strong>${formatDate(task.dataAnalise)}</strong></p>
                                    ${task.semanaDeTrabalho ? `<p class="text-xs text-orange-600 font-medium">Semana de Trabalho: <strong>${task.semanaDeTrabalho}</strong></p>` : ''}
                                </div>
                                <button data-id="${task.id}" class="toggle-details-btn p-1 rounded-full hover:bg-slate-200 ${isCollapsed ? 'collapsed' : ''}">
                                    <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                            <div class="details-content ${isCollapsed ? 'hidden' : ''}">
                                ${occurrenceCountHTML}
                                ${completionDateHTML}
                                
                                <div class="space-y-3 text-sm mt-4">
                                    <div class="flex items-center justify-between"><span class="font-semibold text-slate-600">Backup:</span><select data-id="${task.id}" data-type="backup" class="status-select border-none text-right font-semibold text-sm rounded-md p-1 ${statusClasses[task.statusBackup]}"><option value="Pendente" ${task.statusBackup === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Andamento" ${task.statusBackup === 'Em Andamento' ? 'selected' : ''}>Em Andamento</option><option value="Concluído" ${task.statusBackup === 'Concluído' ? 'selected' : ''}>Concluído</option><option value="Não visualizar" ${task.statusBackup === 'Não visualizar' ? 'selected' : ''}>Não visualizar</option></select></div>
                                    <div class="flex items-center justify-between"><span class="font-semibold text-slate-600">Análise:</span><select data-id="${task.id}" data-type="analise" class="status-select border-none text-right font-semibold text-sm rounded-md p-1 ${statusClasses[task.statusAnalise]}"><option value="Pendente" ${task.statusAnalise === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Em Análise" ${task.statusAnalise === 'Em Análise' ? 'selected' : ''}>Em Análise</option><option value="Concluída" ${task.statusAnalise === 'Concluída' ? 'selected' : ''}>Concluída</option><option value="Não visualizar" ${task.statusAnalise === 'Não visualizar' ? 'selected' : ''}>Não visualizar</option></select></div>
                                </div>
                                ${ocorrenciaDetailsHTML}
                                ${detailsButtonHTML}
                            </div>
                        `;
                        taskList.appendChild(card);
                    });
                }
            };
            
            const updateDashboard = () => {
                const currentWeekFilter = filtroSemana.value ? parseInt(filtroSemana.value) : null;
                const filteredTasks = tasks.filter(task => {
                    const matchCondominio = task.condominio.toLowerCase().includes(filtroCondominio.value.toLowerCase());
                    const matchData = !filtroData.value || task.dataAnalise === filtroData.value;
                    const matchBackup = !filtroBackup.value || task.statusBackup === filtroBackup.value;
                    const matchAnalise = !filtroAnalise.value || task.statusAnalise === filtroAnalise.value;
                    let matchSemana = true;
                     if (currentWeekFilter && !filtroData.value) {
                        matchSemana = (task.semanaDeTrabalho === currentWeekFilter); 
                    }
                    if (filtroData.value) {
                        matchSemana = true; 
                    }
                    return matchCondominio && matchData && matchBackup && matchAnalise && matchSemana;
                });
                
                document.getElementById('total-solicitacoes').textContent = filteredTasks.length;
                document.getElementById('backups-pendentes').textContent = filteredTasks.filter(t => t.statusBackup === 'Pendente').length;
                document.getElementById('analises-pendentes').textContent = filteredTasks.filter(t => t.statusAnalise === 'Pendente').length;
                
                // Weekly Performance Update & Weekly Occurrence Count
                const today = new Date();
                const dayOfWeek = today.getDay() || 7; // Sunday = 0, make it 7
                const monday = new Date(today);
                monday.setDate(today.getDate() - dayOfWeek + 1);
                monday.setHours(0, 0, 0, 0);
                
                const currentDay = new Date();
                currentDay.setHours(23, 59, 59, 999);

                // *** FIX: Only use active tasks (tasks array) for weekly stats ***
                const completedThisWeek = tasks.filter(task => 
                    task.dataConclusao && 
                    new Date(task.dataConclusao + 'T00:00:00') >= monday &&
                    new Date(task.dataConclusao + 'T00:00:00') <= currentDay
                );

                const totalCompleted = completedThisWeek.length;
                const totalOccurrencesWeek = completedThisWeek.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);

                // Update Weekly Occurrence Card
                document.getElementById('total-ocorrencias-semana').textContent = totalOccurrencesWeek;

                // Calculate Ocorrências / Análises for Weekly Productivity
                const productivityMetric = totalCompleted > 0 ? (totalOccurrencesWeek / totalCompleted).toFixed(1) : '0.0'; 
                document.getElementById('produtividade-semanal').textContent = productivityMetric; 
            };
            
            const updateCharts = () => {
                // Main Chart (Weekly)
                const today = new Date();
                const dayOfWeek = today.getDay() || 7; // Sunday = 0, make it 7
                const monday = new Date(today);
                monday.setDate(today.getDate() - dayOfWeek + 1);
                monday.setHours(0, 0, 0, 0);
                
                const currentDay = new Date();
                currentDay.setHours(23, 59, 59, 999);

                // *** FIX: Only use active tasks (tasks array) for weekly chart ***
                const completedThisWeek = tasks.filter(task => 
                    task.dataConclusao && 
                    new Date(task.dataConclusao + 'T00:00:00') >= monday &&
                    new Date(task.dataConclusao + 'T00:00:00') <= currentDay
                );
                
                const dataByCondo = completedThisWeek.reduce((acc, task) => {
                    if (!acc[task.condominio]) acc[task.condominio] = { ocorrencias: 0 };
                    if (task.ocorrencia === 'Sim' && task.ocorrencias) acc[task.condominio].ocorrencias += task.ocorrencias.length;
                    return acc;
                }, {});

                const labels = Object.keys(dataByCondo);
                const ocorrenciasData = labels.map(label => dataByCondo[label].ocorrencias);
                if (ocorrenciasChart) {
                    ocorrenciasChart.data.labels = labels;
                    ocorrenciasChart.data.datasets[0].data = ocorrenciasData;
                    ocorrenciasChart.update();
                }
            };

            const setupCharts = () => {
                const ocorrenciasCtx = document.getElementById('ocorrenciasChart').getContext('2d');
                ocorrenciasChart = new Chart(ocorrenciasCtx, {
                    type: 'bar', data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(249, 115, 22, 0.6)', borderColor: 'rgba(249, 115, 22, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
                
                const periodCtx = document.getElementById('periodChart').getContext('2d');
                periodChart = new Chart(periodCtx, {
                    type: 'bar', data: { labels: [], datasets: [{ label: '# de Ocorrências', data: [], backgroundColor: 'rgba(249, 115, 22, 0.6)', borderColor: 'rgba(249, 115, 22, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });

                const periodCategoryCtx = document.getElementById('periodCategoryChart').getContext('2d');
                periodCategoryChart = new Chart(periodCategoryCtx, {
                    type: 'pie', data: { labels: [], datasets: [{ label: 'Ocorrências por Categoria', data: [], backgroundColor: ['#ea580c', '#f97316', '#f7b41e', '#fbbf24', '#fcd34d', '#fed7aa', '#ffedd5'] }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
                
                const pdvTrendCtx = document.getElementById('pdvTrendChart').getContext('2d');
                pdvTrendChart = new Chart(pdvTrendCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Ocorrências por Mês', data: [], borderColor: 'rgba(249, 115, 22, 1)', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMM/yy' } } } } }
                });
                
                // --- Gráficos Anuais ---
                const annualMonthlyCtx = document.getElementById('annualReportChart_Monthly').getContext('2d');
                annualMonthlyChart = new Chart(annualMonthlyCtx, {
                    type: 'bar', data: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], datasets: [{ label: 'Ocorrências por Mês', data: [], backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
                
                const annualCategoryCtx = document.getElementById('annualReportChart_Category').getContext('2d');
                annualCategoryChart = new Chart(annualCategoryCtx, {
                    type: 'doughnut', data: { labels: [], datasets: [{ label: 'Ocorrências por Categoria', data: [], backgroundColor: ['#ea580c', '#f97316', '#f7b41e', '#fbbf24', '#fcd34d', '#fed7aa', '#ffedd5'] }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });

                const annualCondoCtx = document.getElementById('annualReportChart_Condo').getContext('2d');
                annualCondoChart = new Chart(annualCondoCtx, {
                    type: 'bar', data: { labels: [], datasets: [{ label: 'Top 10 Condomínios', data: [], backgroundColor: 'rgba(249, 115, 22, 0.6)', borderColor: 'rgba(249, 115, 22, 1)', borderWidth: 1 }] },
                    options: { maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision: 0 } } } }
                });
            };

            const refreshUI = () => {
                saveTasks();
                renderTasks();
                updateDashboard();
                updateCharts();
            };
            
            [filtroCondominio, filtroData, filtroSemana, filtroBackup, filtroAnalise].forEach(el => el.addEventListener('input', refreshUI));

            // Desabilitar filtro de data se semana for preenchido
            filtroSemana.addEventListener('input', () => {
                if (filtroSemana.value) {
                    filtroData.value = '';
                    filtroData.disabled = true;
                } else {
                    filtroData.disabled = false;
                }
            });
            // Desabilitar filtro de semana se data for preenchida
            filtroData.addEventListener('input', () => {
                 if (filtroData.value) {
                    filtroSemana.value = '';
                    filtroSemana.disabled = true;
                } else {
                    filtroSemana.disabled = false;
                }
            });


            addTaskBtn.addEventListener('click', () => {
                document.getElementById('form-semana-trabalho').value = getWeekNumber(new Date());
                taskModal.classList.remove('hidden')
            });
            cancelBtn.addEventListener('click', () => {
                taskModal.classList.add('hidden');
                autocompleteList.classList.add('hidden');
            });
            ocorrenciaCancelBtn.addEventListener('click', () => {
                 // Ensure edits are cancelled if modal is closed without saving form
                const editingItem = ocorrenciaListDiv.querySelector('.ocorrencia-item.editing');
                if (editingItem) {
                    const cancelBtn = editingItem.querySelector('.cancel-edit-ocorrencia-btn');
                    if(cancelBtn) cancelBtn.click();
                }
                ocorrenciaModal.classList.add('hidden');
            });


            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const today = new Date().toISOString().split('T')[0];
                const newTask = {
                    id: Date.now(), dataSolicitacao: today, condominio: document.getElementById('form-condominio').value,
                    dataAnalise: document.getElementById('form-data-analise').value,
                    semanaDeTrabalho: parseInt(document.getElementById('form-semana-trabalho').value) || null,
                    statusBackup: 'Pendente', dataBackup: '',
                    statusAnalise: 'Pendente', ocorrencia: null, ocorrencias: [], acao: '',
                    obs: document.getElementById('form-observacoes').value,
                    isExpanded: true,
                    dataConclusao: null,
                };
                tasks.push(newTask);
                taskForm.reset();
                taskModal.classList.add('hidden');
                autocompleteList.classList.add('hidden');
                refreshUI();
            });

            bulkAddBtn.addEventListener('click', () => {
                // document.getElementById('bulk-week-number').value = getWeekNumber(new Date()); // Removido, pois a semana vem da planilha
                bulkAddModal.classList.remove('hidden');
            });

            bulkCancelBtn.addEventListener('click', () => {
                bulkAddModal.classList.add('hidden');
            });

            bulkAddForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const inputText = bulkInputArea.value.trim();
                
                if (!inputText) {
                     showNotification("Por favor, cole os dados da planilha.");
                    return;
                }

                const lines = inputText.split('\n');
                const today = new Date().toISOString().split('T')[0];
                let newTasksCount = 0;
                let skippedCount = 0;
                let archivedCount = 0;

                // --- Nova Lógica de Importação ---
                const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
                
                const idxSemana = headers.findIndex(h => h.includes('semana'));
                const idxData = headers.findIndex(h => h.includes('dia a visualizar'));
                const idxUnidade = headers.findIndex(h => h.includes('unidade'));
                const idxStatus = headers.findIndex(h => h.includes('status'));
                const idxOC = headers.findIndex(h => h === 'oc' || h === 'ocorrências');

                if (idxData === -1 || idxUnidade === -1 || idxStatus === -1 || idxSemana === -1) {
                    showNotification("Erro: Colunas 'Semana', 'Dia a visualizar', 'Unidade' ou 'Status' não encontradas. Verifique o cabeçalho.");
                    return;
                }

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line.trim()) continue;

                    const columns = line.split('\t');
                    
                    const dataStr = columns[idxData] ? columns[idxData].trim() : '';
                    const condominio = columns[idxUnidade] ? columns[idxUnidade].trim() : '';
                    const status = columns[idxStatus] ? columns[idxStatus].trim().toLowerCase() : 'pendente';
                    const ocCount = idxOC !== -1 ? (parseInt(columns[idxOC]) || 0) : 0;
                    const semanaTrabalho = columns[idxSemana] ? (parseInt(columns[idxSemana].replace('Semana', '')) || null) : null;
                    
                    if (!dataStr || !condominio || !semanaTrabalho) {
                        console.warn(`Linha ignorada (dados essenciais faltando): "${line}"`);
                        continue;
                    }

                    const dateParts = dataStr.split('/');
                    if (dateParts.length !== 3 || dateParts[2].length < 4 || isNaN(parseInt(dateParts[0])) || isNaN(parseInt(dateParts[1])) || isNaN(parseInt(dateParts[2]))) {
                       console.warn(`Linha ignorada (formato de data inválido): "${line}"`);
                       continue;
                    }
                    const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    
                    const isDuplicate = tasks.some(task => task.condominio === condominio && task.dataAnalise === formattedDate) || 
                                      archivedTasks.some(task => task.condominio === condominio && task.dataAnalise === formattedDate);

                    if (isDuplicate) {
                        skippedCount++;
                        continue;
                    }

                    let taskOcorrencias = [];
                    if (ocCount > 0) {
                        for(let j=0; j < ocCount; j++) {
                            taskOcorrencias.push({
                                id: Date.now() + i + j,
                                categoria: 'Importada',
                                desc: 'Ocorrência importada da planilha',
                                horarioInicial: '',
                                horarioFinal: '',
                                isInconclusiva: false
                            });
                        }
                    }

                    const newTask = {
                        id: Date.now() + i,
                        dataSolicitacao: today,
                        condominio: condominio,
                        dataAnalise: formattedDate,
                        semanaDeTrabalho: semanaTrabalho,
                        statusBackup: status === 'finalizado' || status === 'finalizada' ? 'Concluído' : 'Pendente',
                        dataBackup: '',
                        statusAnalise: status === 'finalizado' || status === 'finalizada' ? 'Concluída' : 'Pendente',
                        ocorrencia: ocCount > 0 ? 'Sim' : 'Não',
                        ocorrencias: taskOcorrencias,
                        acao: '',
                        obs: 'Importado da planilha',
                        isExpanded: true,
                        dataConclusao: status === 'finalizado' || status === 'finalizada' ? formattedDate : null, // Assume data de conclusão = data de análise
                    };

                    if (status === 'finalizado' || status === 'finalizada') {
                        archivedTasks.push(newTask);
                        archivedCount++;
                    } else {
                        tasks.push(newTask);
                        newTasksCount++;
                    }
                }
                
                bulkAddModal.classList.add('hidden');
                bulkAddForm.reset();
                
                refreshUI();
                showNotification(`${newTasksCount} análises ativas e ${archivedCount} análises arquivadas importadas. ${skippedCount} duplicadas foram ignoradas.`);
            });

            ocorrenciaForm.addEventListener('submit', (e) => {
                e.preventDefault();
                 // Save edits if any item is in edit mode before submitting
                const editingItem = ocorrenciaListDiv.querySelector('.ocorrencia-item.editing');
                if (editingItem) {
                    const saveBtn = editingItem.querySelector('.save-edit-ocorrencia-btn');
                    if(saveBtn) saveBtn.click(); // Trigger save for the currently edited item
                }

                const taskId = parseInt(document.getElementById('ocorrencia-task-id').value);
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    const newOcorrencias = Array.from(ocorrenciaListDiv.querySelectorAll('.ocorrencia-item')).map(item => ({
                        id: item.dataset.id,
                        categoria: item.querySelector('.view-mode .desc-text').dataset.categoria,
                        desc: item.querySelector('.view-mode .desc-text span.font-medium').textContent, // Get only text
                        horarioInicial: item.querySelector('.view-mode .time-text').dataset.start,
                        horarioFinal: item.querySelector('.view-mode .time-text').dataset.end,
                        isInconclusiva: !!item.querySelector('.view-mode span.bg-slate-400')
                    }));
                    task.ocorrencias = newOcorrencias;
                    task.ocorrencia = newOcorrencias.length > 0 ? 'Sim' : 'Não';
                }
                ocorrenciaModal.classList.add('hidden');
                refreshUI();
            });
            
            taskList.addEventListener('change', (e) => {
                if (e.target.classList.contains('status-select')) {
                    const taskId = parseInt(e.target.dataset.id);
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        if (e.target.dataset.type === 'backup') {
                            task.statusBackup = e.target.value;
                        }
                        if (e.target.dataset.type === 'analise') {
                            const oldStatus = task.statusAnalise;
                            task.statusAnalise = e.target.value;
                            
                            // *** CORREÇÃO: Atualiza dataConclusao sempre que for movido para 'Concluída' ***
                            if (task.statusAnalise === 'Concluída') {
                                task.dataConclusao = new Date().toISOString().split('T')[0]; // Sempre define/sobrescreve a data de conclusão
                            } else if (task.statusAnalise !== 'Concluída') {
                                // Não limpa a data de conclusão ao mover para "Em Análise"
                                // Apenas limpa se for para "Pendente"
                                if(task.statusAnalise === 'Pendente') {
                                    task.dataConclusao = null;
                                }
                            }
                        }
                        refreshUI();
                    }
                }
            });

            const populateCategorySelect = (selectElement, selectedValue = '') => {
                selectElement.innerHTML = ''; // Clear existing
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === selectedValue) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            };
            
            const updateMultiOcVisuals = () => {
                const items = Array.from(ocorrenciaListDiv.querySelectorAll('.ocorrencia-item'));
                const startTimeMap = new Map();

                // Reset all backgrounds
                items.forEach(item => {
                    item.style.backgroundColor = '#f1f5f9'; // bg-slate-100
                });

                // Group by start time
                items.forEach(item => {
                    let startTime;
                    if (item.classList.contains('editing')) {
                        startTime = item.querySelector('.edit-start').value;
                    } else {
                        startTime = item.querySelector('.view-mode .time-text').dataset.start;
                    }
                    
                    if (startTime) { // Only group if time is set
                        if (!startTimeMap.has(startTime)) {
                            startTimeMap.set(startTime, []);
                        }
                        startTimeMap.get(startTime).push(item);
                    }
                });

                let colorIndex = 0;
                // Apply colors to groups
                for (const [startTime, groupedItems] of startTimeMap.entries()) {
                    if (groupedItems.length > 1) {
                        const color = multiOcColors[colorIndex % multiOcColors.length];
                        groupedItems.forEach(item => {
                            item.style.backgroundColor = color;
                        });
                        colorIndex++;
                    }
                }
            };

            const renderOcorrenciaItemInModal = (ocor) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ocorrencia-item p-3 bg-slate-100 rounded-md';
                itemDiv.dataset.id = ocor.id || Date.now(); // Ensure ID exists
                const descText = ocor.desc.replace(/.*: \s*/, ''); // Clean description if it has category prefix
                const categoria = ocor.categoria || 'Outros';
                const inconclusivaBadge = ocor.isInconclusiva ? `<span class="text-xs font-semibold text-white bg-slate-400 px-2 py-0.5 rounded-full ml-2">Inconclusiva</span>` : '';

                itemDiv.innerHTML = `
                    <div class="view-mode">
                        <div class="flex items-start justify-between">
                            <div class="flex-grow mr-2">
                                <p class="desc-text font-semibold text-slate-800" data-categoria="${categoria}">${categoria}: <span class="font-medium">${descText}</span></p>
                                <div class="flex items-center mt-1">
                                    <p class="time-text text-sm text-slate-500" data-start="${ocor.horarioInicial || ''}" data-end="${ocor.horarioFinal || ''}">Horário: ${ocor.horarioInicial || 'N/A'} - ${ocor.horarioFinal || 'N/A'}</p>
                                    ${inconclusivaBadge}
                                </div>
                            </div>
                             <div class="flex flex-col items-end flex-shrink-0 space-y-1">
                                <button type="button" class="edit-ocorrencia-item-btn text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded hover:bg-orange-200">Editar</button>
                                <button type="button" class="remove-ocorrencia-btn text-red-500 hover:text-red-700 font-bold text-xl leading-none">&times;</button>
                             </div>
                        </div>
                    </div>
                    <div class="edit-mode hidden">
                        <div class="mb-2">
                             <label class="block text-xs font-medium text-slate-600">Categoria</label>
                             <select class="edit-categoria w-full border border-slate-300 rounded-md p-1 text-sm"></select>
                        </div>
                         <div class="mb-2">
                             <label class="block text-xs font-medium text-slate-600">Descrição</label>
                            <textarea class="edit-desc w-full border border-slate-300 rounded-md p-1 mb-2 text-sm">${descText}</textarea>
                        </div>
                        <div class="flex gap-2">
                             <div class="w-full">
                                <label class="block text-xs font-medium text-slate-600">Início</label>
                                <input type="time" step="1" class="edit-start border border-slate-300 rounded-md p-1 text-sm w-full" value="${ocor.horarioInicial || ''}">
                             </div>
                             <div class="w-full">
                                <label class="block text-xs font-medium text-slate-600">Fim</label>
                                <input type="time" step="1" class="edit-end border border-slate-300 rounded-md p-1 text-sm w-full" value="${ocor.horarioFinal || ''}">
                             </div>
                        </div>
                        <div class="mt-2">
                            <label class="flex items-center">
                                <input type="checkbox" class="edit-inconclusiva h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500" ${ocor.isInconclusiva ? 'checked' : ''}>
                                <span class="ml-2 text-sm font-medium text-slate-700">Inconclusiva</span>
                            </label>
                        </div>
                        <div class="mt-2 text-right">
                             <button type="button" class="cancel-edit-ocorrencia-btn text-xs bg-slate-200 text-slate-700 px-2 py-1 rounded hover:bg-slate-300 mr-1">Cancelar</button>
                            <button type="button" class="save-edit-ocorrencia-btn text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">Salvar Edição</button>
                        </div>
                    </div>
                `;
                ocorrenciaListDiv.appendChild(itemDiv);
                
                // Populate category select in edit mode
                const editSelect = itemDiv.querySelector('.edit-categoria');
                populateCategorySelect(editSelect, categoria);
            }


            addOcorrenciaBtn.addEventListener('click', () => {
                const descInput = document.getElementById('add-ocorrencia-desc');
                const startInput = document.getElementById('add-horario-inicial');
                const endInput = document.getElementById('add-horario-final');
                const categoriaSelect = document.getElementById('add-ocorrencia-categoria');
                const isInconclusiva = addOcorrenciaInconclusiva.checked;
                
                if (!descInput.value.trim()) {
                    descInput.classList.add('border-red-500');
                    setTimeout(() => descInput.classList.remove('border-red-500'), 2000);
                    return;
                }
                renderOcorrenciaItemInModal({
                    id: Date.now(), 
                    categoria: categoriaSelect.value,
                    desc: descInput.value, 
                    horarioInicial: startInput.value, 
                    horarioFinal: endInput.value,
                    isInconclusiva: isInconclusiva
                });
                descInput.value = ''; startInput.value = ''; endInput.value = '';
                addOcorrenciaInconclusiva.checked = false;
                categoriaSelect.value = categories[0] || 'Outros'; // Reset select
                updateMultiOcVisuals();
            });
            
             ocorrenciaListDiv.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.ocorrencia-item');
                if (!itemDiv) return;

                if (e.target.classList.contains('remove-ocorrencia-btn')) {
                    itemDiv.remove();
                    updateMultiOcVisuals();
                } else if (e.target.classList.contains('edit-ocorrencia-item-btn')) {
                     // Ensure only one item is editable at a time
                    ocorrenciaListDiv.querySelectorAll('.ocorrencia-item.editing').forEach(el => {
                         const cancelBtn = el.querySelector('.cancel-edit-ocorrencia-btn');
                         if(cancelBtn) cancelBtn.click(); // Cancel existing edits
                    });
                    itemDiv.classList.add('editing');
                    itemDiv.querySelector('.view-mode').classList.add('hidden');
                    itemDiv.querySelector('.edit-mode').classList.remove('hidden');
                } else if (e.target.classList.contains('save-edit-ocorrencia-btn')) {
                    const newCategoria = itemDiv.querySelector('.edit-categoria').value;
                    const newDesc = itemDiv.querySelector('.edit-desc').value;
                    const newStart = itemDiv.querySelector('.edit-start').value;
                    const newEnd = itemDiv.querySelector('.edit-end').value;
                    const newInconclusiva = itemDiv.querySelector('.edit-inconclusiva').checked;

                    // Update view mode elements
                    const descText = itemDiv.querySelector('.view-mode .desc-text');
                    const timeTextParent = itemDiv.querySelector('.view-mode .time-text').parentElement;
                    
                    descText.innerHTML = `<span class="font-semibold text-slate-800">${newCategoria}:</span> <span class="font-medium">${newDesc}</span>`;
                    descText.dataset.categoria = newCategoria;
                    
                    const newInconclusivaBadge = newInconclusiva ? `<span class="text-xs font-semibold text-white bg-slate-400 px-2 py-0.5 rounded-full ml-2">Inconclusiva</span>` : '';
                    timeTextParent.innerHTML = `
                        <p class="time-text text-sm text-slate-500" data-start="${newStart}" data-end="${newEnd}">Horário: ${newStart || 'N/A'} - ${newEnd || 'N/A'}</p>
                        ${newInconclusivaBadge}
                    `;

                    // Switch back to view mode
                    itemDiv.classList.remove('editing');
                    itemDiv.querySelector('.view-mode').classList.remove('hidden');
                    itemDiv.querySelector('.edit-mode').classList.add('hidden');
                    updateMultiOcVisuals();
                } else if (e.target.classList.contains('cancel-edit-ocorrencia-btn')) {
                     // Reset input values to original before canceling
                    const descText = itemDiv.querySelector('.view-mode .desc-text');
                    const timeText = itemDiv.querySelector('.view-mode .time-text');
                    itemDiv.querySelector('.edit-categoria').value = descText.dataset.categoria;
                    itemDiv.querySelector('.edit-desc').value = descText.querySelector('span.font-medium').textContent;
                    itemDiv.querySelector('.edit-start').value = timeText.dataset.start;
                    itemDiv.querySelector('.edit-end').value = timeText.dataset.end;
                    itemDiv.querySelector('.edit-inconclusiva').checked = !!itemDiv.querySelector('.view-mode span.bg-slate-400');

                    // Switch back to view mode
                    itemDiv.classList.remove('editing');
                    itemDiv.querySelector('.view-mode').classList.remove('hidden');
                    itemDiv.querySelector('.edit-mode').classList.add('hidden');
                    updateMultiOcVisuals();
                }
            });

            taskList.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.toggle-details-btn, .edit-ocorrencia-btn, .delete-task-btn, .archive-single-btn');
                if (!targetButton) return;
                
                const taskId = parseInt(targetButton.dataset.id);

                if (targetButton.classList.contains('toggle-details-btn')) {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        task.isExpanded = !task.isExpanded;
                        refreshUI();
                    }
                }
                
                if (targetButton.classList.contains('edit-ocorrencia-btn')) {
                    const task = tasks.find(t => t.id === taskId);
                    if (task) {
                        populateCategorySelect(addOcorrenciaCategoriaSelect, categories[0] || 'Outros');
                        document.getElementById('ocorrencia-task-id').value = task.id;
                        ocorrenciaListDiv.innerHTML = ''; // Clear previous items
                        // Ensure all items are rendered correctly
                         if (task.ocorrencias) {
                            task.ocorrencias.forEach(ocor => renderOcorrenciaItemInModal(ocor));
                        }
                        updateMultiOcVisuals();
                         // Reset add form
                        document.getElementById('add-ocorrencia-desc').value = '';
                        document.getElementById('add-horario-inicial').value = '';
                        document.getElementById('add-horario-final').value = '';
                        addOcorrenciaInconclusiva.checked = false;
                        ocorrenciaModal.classList.remove('hidden');
                    }
                }

                if (targetButton.classList.contains('archive-single-btn')) {
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    
                    if (taskIndex > -1) {
                        const [taskToArchive] = tasks.splice(taskIndex, 1); // Remove from active tasks
                        taskToArchive.archivedReason = 'manual'; // Add reason
                        archivedTasks.push(taskToArchive); // Add to archived tasks
                        
                        refreshUI(); // Update the UI
                        showNotification('Análise arquivada manualmente.');
                    }
                }

                if (targetButton.classList.contains('delete-task-btn')) {
                    tasks = tasks.filter(t => t.id !== taskId);
                    refreshUI();
                }
            });

            formCondominioInput.addEventListener('input', () => {
                const inputValue = formCondominioInput.value.toLowerCase();
                autocompleteList.innerHTML = '';
                if (inputValue.length === 0) {
                    autocompleteList.classList.add('hidden');
                    return;
                }
                const uniqueCondominios = [...new Set(tasks.map(task => task.condominio))];
                const suggestions = uniqueCondominios.filter(condo => condo.toLowerCase().startsWith(inputValue));
                if (suggestions.length > 0) {
                    suggestions.forEach(suggestion => {
                        const item = document.createElement('div');
                        item.className = 'p-2 hover:bg-orange-100 cursor-pointer text-sm';
                        item.textContent = suggestion;
                        item.addEventListener('click', () => {
                            formCondominioInput.value = suggestion;
                            autocompleteList.classList.add('hidden');
                        });
                        autocompleteList.appendChild(item);
                    });
                    autocompleteList.classList.remove('hidden');
                } else {
                    autocompleteList.classList.add('hidden');
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!formCondominioInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                    autocompleteList.classList.add('hidden');
                }
            });

            renameCondoBtn.addEventListener('click', () => {
                const uniqueCondominios = [...new Set([...tasks, ...archivedTasks].map(task => task.condominio))].sort(); // Use all tasks
                oldNameSelect.innerHTML = '<option value="">Selecione um condomínio</option>';
                uniqueCondominios.forEach(condo => {
                    const option = document.createElement('option');
                    option.value = condo;
                    option.textContent = condo;
                    oldNameSelect.appendChild(option);
                });
                newNameInput.value = '';
                renameModal.classList.remove('hidden');
            });


            renameCancelBtn.addEventListener('click', () => renameModal.classList.add('hidden'));

            renameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldName = oldNameSelect.value;
                const newName = newNameInput.value.trim();
                if (!oldName || !newName || oldName === newName) {
                    renameModal.classList.add('hidden');
                    return;
                }
                tasks.forEach(task => {
                    if (task.condominio === oldName) {
                        task.condominio = newName;
                    }
                });
                 archivedTasks.forEach(task => { // Rename in archive too
                    if (task.condominio === oldName) {
                        task.condominio = newName;
                    }
                });
                renameModal.classList.add('hidden');
                refreshUI();
            });
            
            expandAllBtn.addEventListener('click', () => {
                tasks.forEach(t => t.isExpanded = true);
                refreshUI();
            });

            collapseAllBtn.addEventListener('click', () => {
                tasks.forEach(t => t.isExpanded = false);
                refreshUI();
            });
            
            const performAutoBackup = () => {
                const today = new Date().toISOString().split('T')[0];
                const lastBackupDate = localStorage.getItem('lastBackupDate');

                if (today !== lastBackupDate) {
                     try {
                        const allData = {
                            tasks: JSON.parse(localStorage.getItem('monitoramentoTasks')) || [],
                            archivedTasks: JSON.parse(localStorage.getItem('archivedTasks')) || [],
                            categories: JSON.parse(localStorage.getItem('monitoramentoCategorias')) || []
                        };
                        if (allData.tasks.length === 0 && allData.archivedTasks.length === 0) return;
                        
                        const dataStr = JSON.stringify(allData, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.download = `backup_automatico_${today}.json`;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                        localStorage.setItem('lastBackupDate', today);
                        console.log('Backup automático realizado com sucesso.');
                    } catch (error) {
                        console.error('Falha no backup automático:', error);
                    }
                }
            };

            const performWeeklyArchive = () => {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const lastResetStr = localStorage.getItem('lastResetDate');
                let shouldReset = false;

                if (!lastResetStr) {
                    shouldReset = true; // First time running
                } else {
                    const lastResetDate = new Date(lastResetStr + 'T00:00:00');
                    const nextResetDate = new Date(lastResetDate);
                    nextResetDate.setDate(lastResetDate.getDate() + 7);
                    
                    if (today >= nextResetDate) {
                        shouldReset = true;
                    }
                }

                if (shouldReset) {
                    console.log("Realizando arquivamento semanal automático...");
                    const currentDayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday...
                    const diffToMonday = today.getDate() - currentDayOfWeek + (currentDayOfWeek === 0 ? -6 : 1); // Adjust to get Monday
                    const mondayOfCurrentWeek = new Date(today.setDate(diffToMonday));
                    mondayOfCurrentWeek.setHours(0, 0, 0, 0);
                    const currentWeekNumber = getWeekNumber(mondayOfCurrentWeek);

                    let tasksToArchive = [];
                    let remainingTasks = [];
                    let count = 0;

                    tasks.forEach(task => {
                         if (task.dataAnalise && !isNaN(new Date(task.dataAnalise + 'T00:00:00'))) {
                            const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                            // Archive if EITHER dataAnalise is old AND no week number is set
                            // OR if the registered week number is less than the current week number.
                            const taskWeek = task.semanaDeTrabalho || 0;
                            if (taskDate < mondayOfCurrentWeek && (taskWeek < currentWeekNumber || taskWeek === 0) ) {
                                task.archivedReason = 'auto-weekly'; // Add reason
                                tasksToArchive.push(task);
                                count++;
                            } else {
                                remainingTasks.push(task);
                            }
                        } else {
                             remainingTasks.push(task);
                             console.warn(`Tarefa ${task.id} mantida pois a data de análise é inválida ou ausente.`);
                        }
                    });

                    if (count > 0) {
                        archivedTasks.push(...tasksToArchive);
                        tasks = remainingTasks;
                        saveTasks(); // Save immediately after archiving
                        showNotification(`${count} análises de semanas anteriores foram arquivadas automaticamente.`);
                        refreshUI(); // Update UI after saving and notification
                    } else {
                         console.log("Nenhuma análise anterior à semana atual encontrada para arquivamento automático.");
                    }

                    localStorage.setItem('lastResetDate', todayStr);
                }
            };


            restoreBtn.addEventListener('click', () => {
                restoreInput.click();
            });

            restoreInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                fileToRestore = file;
                restoreConfirmModal.classList.remove('hidden');
                restoreInput.value = ''; 
            });

            restoreConfirmCancelBtn.addEventListener('click', () => {
                fileToRestore = null;
                restoreConfirmModal.classList.add('hidden');
            });

            restoreConfirmProceedBtn.addEventListener('click', () => {
                if (!fileToRestore) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data && Array.isArray(data.tasks) && Array.isArray(data.archivedTasks)) {
                            tasks = data.tasks;
                            archivedTasks = data.archivedTasks;
                        } else if (Array.isArray(data)) { // For old backup format
                            tasks = data;
                            archivedTasks = [];
                        } else {
                             throw new Error('Formato de arquivo inválido.');
                        }
                        
                        // Restore categories if they exist in backup, otherwise keep current
                        if (data && Array.isArray(data.categories)) {
                            categories = data.categories;
                            saveCategories();
                        }

                        refreshUI();
                        showNotification('Backup restaurado com sucesso!');
                    } catch (error) {
                        console.error('Erro ao restaurar backup:', error);
                        showNotification('Erro ao ler o arquivo de backup. Verifique se o arquivo é válido.');
                    } finally {
                        fileToRestore = null;
                        restoreConfirmModal.classList.add('hidden');
                    }
                };
                reader.onerror = () => {
                    showNotification('Não foi possível ler o arquivo selecionado.');
                    fileToRestore = null;
                    restoreConfirmModal.classList.add('hidden');
                };
                reader.readAsText(fileToRestore);
            });
            
            periodAnalysisBtn.addEventListener('click', () => {
                // Populate category filter on modal open
                periodCategoryFilter.innerHTML = '<option value="">Todas Categorias</option>';
                categories.forEach(cat => {
                    periodCategoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                periodResultsContent.classList.add('hidden'); // Hide old results
                periodAnalysisModal.classList.remove('hidden');
            });
            periodAnalysisCloseBtn.addEventListener('click', () => periodAnalysisModal.classList.add('hidden'));
            
            // REMOVIDO INÍCIO
            // importCsvBtn.addEventListener('click', () => importCsvModal.classList.remove('hidden'));
            // importCsvCancelBtn.addEventListener('click', () => importCsvModal.classList.add('hidden'));
            // importCsvSelectBtn.addEventListener('click', () => {
            //     const userNameInput = document.getElementById('import-user-name');
            //     if (!userNameInput.value.trim()) {
            //         showNotification('Por favor, digite seu nome para filtrar a importação.');
            //         return;
            //     }
            //     importCsvInput.click()
            // });

            // importCsvInput.addEventListener('change', (event) => {
            //      const file = event.target.files[0];
            //     if (!file) return;

            //     const userName = document.getElementById('import-user-name').value.trim().toLowerCase();
            //      if (!userName) {
            //         showNotification('O nome do usuário não foi fornecido para o filtro.');
            //         return;
            //     }

            //     const reader = new FileReader();
            //     reader.onload = (e) => {
            //         try {
            //             const csvContent = e.target.result;
            //             const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            //             const today = new Date().toISOString().split('T')[0];
            //             let newTasksCount = 0;

            //             const startRow = (lines[0] && (lines[0].toLowerCase().includes('semana') || lines[0].toLowerCase().includes('unidade'))) ? 1 : 0;

            //             for(let i = startRow; i < lines.length; i++) {
            //                 const line = lines[i];
            //                 const columns = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                            
            //                 if (columns.length < 6) {
            //                     console.warn(`Linha ignorada no CSV (colunas insuficientes): "${line}"`);
            //                     continue;
            //                 }
            //                 const dateStr = columns[1].trim().replace(/"/g, '');
            //                 const condominio = columns[2].trim().replace(/"/g, '');
            //                 const collaboratorName = columns[5].trim().toLowerCase().replace(/"/g, '');
                            
            //                 if (collaboratorName === userName) {
            //                     const dateParts = dateStr.split('/');
            //                     if (dateParts.length !== 3 || dateParts[2].length < 4 || isNaN(parseInt(dateParts[0])) || isNaN(parseInt(dateParts[1])) || isNaN(parseInt(dateParts[2]))) {
            //                         console.warn(`Linha ignorada no CSV (formato de data inválido): "${line}"`);
            //                         continue;
            //                     }
            //                      const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;

            //                     const newTask = {
            //                         id: Date.now() + i, dataSolicitacao: today, condominio: condominio,
            //                         dataAnalise: formattedDate,
            //                         semanaDeTrabalho: null, // This old import didn't support it
            //                         statusBackup: 'Pendente', dataBackup: '',
            //                         statusAnalise: 'Pendente', ocorrencia: null, ocorrencias: [], acao: '', obs: '',
            //                         isExpanded: true,
            //                         dataConclusao: null,
            //                     };
            //                     tasks.push(newTask);
            //                     newTasksCount++;
            //                 }
            //             };
                        
            //             importCsvModal.classList.add('hidden');
            //             if(newTasksCount > 0){
            //                 refreshUI();
            //                 showNotification(`${newTasksCount} análises foram importadas com sucesso!`);
            //             } else {
            //                 showNotification('Nenhuma análise para o seu nome foi encontrada no arquivo. Verifique se o nome foi digitado corretamente.');
            //             }

            //         } catch (error) {
            //             console.error('Erro ao processar arquivo CSV:', error);
            //             showNotification('Ocorreu um erro ao processar o arquivo. Verifique se ele está no formato .csv correto.');
            //         } finally {
            //             importCsvInput.value = '';
            //             // document.getElementById('import-user-name').value = ''; // Input doesn't exist anymore
            //         }
            //     };
            //     reader.readAsText(file);
            // });
            // REMOVIDO FIM
            
            actionsMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                actionsMenu.classList.toggle('hidden');
            });

            window.addEventListener('click', (e) => {
                if (!actionsMenu.classList.contains('hidden') && !actionsMenuContainer.contains(e.target)) {
                    actionsMenu.classList.add('hidden');
                }
            });
            
            actionsMenu.addEventListener('click', () => {
                actionsMenu.classList.add('hidden');
            });

            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const period = e.target.dataset.period;
                    const today = new Date();
                    let startDate, endDate;

                    if (period === 'this-week') {
                        const dayOfWeek = today.getDay() || 7; // Mon=1 ... Sun=7
                        const diff = today.getDate() - dayOfWeek + 1;
                        startDate = new Date(today.getFullYear(), today.getMonth(), diff);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 4); // Mon + 4 = Fri
                    } else if (period === 'last-week') {
                        const todayCopy = new Date();
                        todayCopy.setDate(todayCopy.getDate() - 7); // Go to last week
                        const dayOfWeek = todayCopy.getDay() || 7;
                        const diff = todayCopy.getDate() - dayOfWeek + 1;
                        startDate = new Date(todayCopy.getFullYear(), todayCopy.getMonth(), diff);
                        endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + 4); // Mon + 4 = Fri
                    } else if (period === 'this-month') {
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    } else if (period === 'last-month') {
                        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    }
                    periodStartDateInput.value = formatDateForInput(startDate);
                    periodEndDateInput.value = formatDateForInput(endDate);
                });
            });

            const updatePeriodReportCharts = (baseFilteredTasks) => {
                // 1. Update Category Pie Chart
                const categoryData = baseFilteredTasks.reduce((acc, task) => {
                    task.ocorrencias.forEach(ocor => {
                        const cat = ocor.categoria || 'Outros';
                        acc[cat] = (acc[cat] || 0) + 1;
                    });
                    return acc;
                }, {});
                periodCategoryChart.data.labels = Object.keys(categoryData);
                periodCategoryChart.data.datasets[0].data = Object.values(categoryData);
                periodCategoryChart.update();

                // 2. Update Condo Bar Chart (respecting category filter)
                const categoryFiltro = periodCategoryFilter.value;
                const tasksForBarChart = !categoryFiltro ? baseFilteredTasks : baseFilteredTasks.filter(task => 
                    task.ocorrencias.some(ocor => (ocor.categoria || 'Outros') === categoryFiltro)
                );
                
                const dataByCondo = tasksForBarChart.reduce((acc, task) => {
                    if (!acc[task.condominio]) acc[task.condominio] = { ocorrencias: 0 };
                    task.ocorrencias.forEach(ocor => {
                         if (!categoryFiltro || (ocor.categoria || 'Outros') === categoryFiltro) {
                            acc[task.condominio].ocorrencias += 1;
                         }
                    });
                    return acc;
                }, {});

                periodChart.data.labels = Object.keys(dataByCondo);
                periodChart.data.datasets[0].data = Object.values(dataByCondo).map(d => d.ocorrencias);
                periodChart.update();
            };


            generateReportBtn.addEventListener('click', () => {
                const startDate = periodStartDateInput.value;
                const endDate = periodEndDateInput.value;
                if (!startDate || !endDate) {
                    showNotification("Por favor, selecione as datas de início e fim.");
                    return;
                }
                const analysisType = document.querySelector('input[name="analysis_type"]:checked').value;
                
                // *** FIX: Determine which tasks to report on ***
                let allTasksForReport;
                if (analysisType === 'dataConclusao') {
                    // Only report on active tasks when filtering by conclusion date
                    allTasksForReport = [...tasks];
                } else {
                    // When filtering by analysis date, include archived tasks for historical data
                    allTasksForReport = [...tasks, ...archivedTasks];
                }

                const filteredTasks = allTasksForReport.filter(task => {
                    const dateToCompare = analysisType === 'dataConclusao' ? task.dataConclusao : task.dataAnalise;
                    if (!dateToCompare) return false;
                    return dateToCompare >= startDate && dateToCompare <= endDate;
                });
                
                const totalDias = filteredTasks.length;
                const uniquePdvs = new Set(filteredTasks.map(task => task.condominio)).size;
                const totalOcorrencias = filteredTasks.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);

                document.getElementById('period-dias').textContent = totalDias;
                document.getElementById('period-pdv').textContent = uniquePdvs;
                document.getElementById('period-oc').textContent = totalOcorrencias;
                
                periodTaskList.innerHTML = '';
                if(filteredTasks.length > 0){
                    filteredTasks.sort((a, b) => new Date(a.dataAnalise) - new Date(b.dataAnalise));
                    filteredTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'text-sm p-2 bg-slate-100 rounded-md flex justify-between items-center';
                        li.innerHTML = `
                           <span><strong>${task.condominio}</strong> - ${formatDate(task.dataAnalise)}</span>
                           <span class="font-bold ${task.ocorrencias && task.ocorrencias.length > 0 ? 'text-red-600' : 'text-emerald-600'}">${task.ocorrencias ? task.ocorrencias.length : 0} ocorr.</span>
                        `;
                        periodTaskList.appendChild(li);
                    });
                } else {
                    periodTaskList.innerHTML = '<li class="text-sm text-slate-500 text-center">Nenhuma análise encontrada para o período.</li>';
                }

                // Update charts
                updatePeriodReportCharts(filteredTasks);
                periodResultsContent.classList.remove('hidden');
            });
            
            // Re-run chart filtering when category filter changes
            periodCategoryFilter.addEventListener('change', () => {
                 const startDate = periodStartDateInput.value;
                const endDate = periodEndDateInput.value;
                if (!startDate || !endDate) return; // Don't do anything if no date is set
                 const analysisType = document.querySelector('input[name="analysis_type"]:checked').value;
                 let allTasksForReport = (analysisType === 'dataConclusao') ? [...tasks] : [...tasks, ...archivedTasks];
                 const filteredTasks = allTasksForReport.filter(task => {
                    const dateToCompare = analysisType === 'dataConclusao' ? task.dataConclusao : task.dataAnalise;
                    if (!dateToCompare) return false;
                    return dateToCompare >= startDate && dateToCompare <= endDate;
                });
                // Only update the charts, not the whole report
                updatePeriodReportCharts(filteredTasks);
            });
            
            annualReportBtn.addEventListener('click', () => {
                const currentYear = new Date().getFullYear();
                document.getElementById('annual-report-title').textContent = `Análise Anual (${currentYear})`;

                const allTasks = [...tasks, ...archivedTasks];
                const tasksThisYear = allTasks.filter(task => 
                    task.dataConclusao && 
                    new Date(task.dataConclusao + 'T00:00:00').getFullYear() === currentYear
                );
                
                const totalConcluidasAno = tasksThisYear.length;
                const totalOcorrenciasAno = tasksThisYear.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);
                
                document.getElementById('annual-total-analises').textContent = totalConcluidasAno;
                document.getElementById('annual-total-ocorrencias').textContent = totalOcorrenciasAno;

                // 1. Monthly Chart
                const monthlyData = new Array(12).fill(0);
                tasksThisYear.forEach(task => {
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                        const month = new Date(task.dataConclusao + 'T00:00:00').getMonth(); // 0-11
                        monthlyData[month] += task.ocorrencias.length;
                    }
                });
                annualMonthlyChart.data.datasets[0].data = monthlyData;
                annualMonthlyChart.update();

                // 2. Category Chart
                const categoryData = tasksThisYear.reduce((acc, task) => {
                    task.ocorrencias.forEach(ocor => {
                        const cat = ocor.categoria || 'Outros';
                        acc[cat] = (acc[cat] || 0) + 1;
                    });
                    return acc;
                }, {});
                annualCategoryChart.data.labels = Object.keys(categoryData);
                annualCategoryChart.data.datasets[0].data = Object.values(categoryData);
                annualCategoryChart.update();
                
                // 3. Top Condos Chart
                const condoData = tasksThisYear.reduce((acc, task) => {
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                         acc[task.condominio] = (acc[task.condominio] || 0) + task.ocorrencias.length;
                    }
                    return acc;
                }, {});
                
                const sortedCondos = Object.entries(condoData)
                                        .sort((a, b) => b[1] - a[1]) // Sort descending
                                        .slice(0, 10); // Get top 10

                annualCondoChart.data.labels = sortedCondos.map(item => item[0]);
                annualCondoChart.data.datasets[0].data = sortedCondos.map(item => item[1]);
                annualCondoChart.update();

                annualReportModal.classList.remove('hidden');
            });
            
            annualReportCloseBtn.addEventListener('click', () => {
                annualReportModal.classList.add('hidden');
            });


            const renderPriorityView = () => {
                const allTasks = [...tasks, ...archivedTasks];
                const occurrenceMap = allTasks.reduce((acc, task) => {
                    if (!acc[task.condominio]) {
                        acc[task.condominio] = 0;
                    }
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                        acc[task.condominio] += task.ocorrencias.length;
                    }
                    return acc;
                }, {});

                const pendingTasks = tasks.filter(task => task.statusBackup === 'Pendente' || task.statusAnalise === 'Pendente');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                pendingTasks.forEach(task => {
                    const taskDate = new Date(task.dataAnalise + 'T00:00:00');
                    const timeDiff = today.getTime() - taskDate.getTime();
                    task.daysOverdue = Math.ceil(timeDiff / (1000 * 3600 * 24));
                });

                pendingTasks.sort((a, b) => {
                    const scoreA = occurrenceMap[a.condominio] || 0;
                    const scoreB = occurrenceMap[b.condominio] || 0;
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    return new Date(a.dataAnalise) - new Date(b.dataAnalise);
                });

                priorityTaskList.innerHTML = '';

                if (pendingTasks.length === 0) {
                    priorityTaskList.innerHTML = '<li class="text-center text-slate-500 p-4 bg-emerald-50 rounded-md">Parabéns! Você está em dia com todas as análises.</li>';
                    return;
                }

                pendingTasks.forEach(task => {
                    let urgencyHTML = '';
                    if (task.daysOverdue > 0) {
                        urgencyHTML = `<span class="font-bold text-red-600">Atrasado ${task.daysOverdue} dia(s)</span>`;
                    } else if (task.daysOverdue === 0) {
                        urgencyHTML = `<span class="font-bold text-amber-600">Para Hoje</span>`;
                    } else {
                        urgencyHTML = `<span class="font-semibold text-orange-600">Futuro (${formatDate(task.dataAnalise)})</span>`;
                    }
                    
                    const historyScore = occurrenceMap[task.condominio] || 0;

                    const li = document.createElement('li');
                    li.className = 'p-3 bg-slate-100 rounded-md flex justify-between items-center';
                    li.innerHTML = `
                        <div>
                            <p class="font-bold text-slate-800">${task.condominio}</p>
                            <p class="text-xs text-slate-500">Histórico: <strong>${historyScore}</strong> ocorrências</p>
                        </div>
                        <div class="text-right">
                            ${urgencyHTML}
                        </div>
                    `;
                    priorityTaskList.appendChild(li);
                });
            };
            
            priorityBtn.addEventListener('click', () => {
                renderPriorityView();
                priorityModal.classList.remove('hidden');
            });

            priorityCloseBtn.addEventListener('click', () => {
                priorityModal.classList.add('hidden');
            });
            
            pdvDashboardBtn.addEventListener('click', () => {
                const uniqueCondominios = [...new Set([...tasks, ...archivedTasks].map(task => task.condominio))].sort();
                pdvSelect.innerHTML = '<option value="">Selecione um condomínio</option>';
                uniqueCondominios.forEach(condo => {
                    pdvSelect.innerHTML += `<option value="${condo}">${condo}</option>`;
                });
                pdvContent.classList.add('hidden');
                pdvDashboardModal.classList.remove('hidden');
            });

            pdvDashboardCloseBtn.addEventListener('click', () => pdvDashboardModal.classList.add('hidden'));

            pdvSelect.addEventListener('change', () => {
                const selectedCondo = pdvSelect.value;
                if (!selectedCondo) {
                    pdvContent.classList.add('hidden');
                    return;
                }
                
                const allTasks = [...tasks, ...archivedTasks];
                const condoTasks = allTasks.filter(t => t.condominio === selectedCondo);
                
                const totalAnalises = condoTasks.length;
                const totalOcorrencias = condoTasks.reduce((acc, task) => acc + (task.ocorrencias ? task.ocorrencias.length : 0), 0);
                
                document.getElementById('pdv-total-analises').textContent = totalAnalises;
                document.getElementById('pdv-total-ocorrencias').textContent = totalOcorrencias;
                
                // Trend Chart Data
                const monthlyData = {};
                for (let i = 11; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const label = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyData[label] = 0;
                }
                
                condoTasks.forEach(task => {
                    if (task.dataAnalise && task.ocorrencias && task.ocorrencias.length > 0) {
                         const d = new Date(task.dataAnalise + 'T00:00:00');
                         const label = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                         if(monthlyData.hasOwnProperty(label)) {
                             monthlyData[label] += task.ocorrencias.length;
                         }
                    }
                });

                pdvTrendChart.data.labels = Object.keys(monthlyData).map(label => new Date(label + '-01T00:00:00'));
                pdvTrendChart.data.datasets[0].data = Object.values(monthlyData);
                pdvTrendChart.update();
                
                // Task List
                const pdvTaskListUl = document.getElementById('pdv-task-list');
                pdvTaskListUl.innerHTML = '';
                if(condoTasks.length > 0) {
                    condoTasks.sort((a,b) => new Date(b.dataAnalise) - new Date(a.dataAnalise)); // Sort descending
                    condoTasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'text-sm p-2 bg-white rounded-md flex justify-between items-center';
                        li.innerHTML = `
                           <span><strong>${formatDate(task.dataAnalise)}</strong> (Semana ${task.semanaDeTrabalho || 'N/A'})</span>
                           <span class="font-bold ${task.ocorrencias && task.ocorrencias.length > 0 ? 'text-red-600' : 'text-emerald-600'}">${task.ocorrencias ? task.ocorrencias.length : 0} ocorr.</span>
                        `;
                        pdvTaskListUl.appendChild(li);
                    });
                } else {
                     pdvTaskListUl.innerHTML = '<li class="text-sm text-slate-500 text-center">Nenhuma análise encontrada.</li>';
                }

                pdvContent.classList.remove('hidden');
            });


            archiveBtn.addEventListener('click', () => archiveModal.classList.remove('hidden'));
            archiveCancelBtn.addEventListener('click', () => archiveModal.classList.add('hidden'));

            archiveForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const days = parseInt(document.querySelector('input[name="archive_period"]:checked').value);
                const thresholdDate = new Date();
                thresholdDate.setDate(thresholdDate.getDate() - days);

                let tasksToArchive = [];
                let remainingTasks = [];

                tasks.forEach(task => {
                    if (task.statusAnalise === 'Concluída' && task.dataConclusao && new Date(task.dataConclusao) < thresholdDate) {
                        tasksToArchive.push(task);
                    } else {
                        remainingTasks.push(task);
                    }
                });

                if (tasksToArchive.length > 0) {
                    archivedTasks.push(...tasksToArchive);
                    tasks = remainingTasks;
                    refreshUI();
                    showNotification(`${tasksToArchive.length} análises foram arquivadas.`);
                } else {
                    showNotification("Nenhuma análise concluída encontrada para o período selecionado.");
                }
                archiveModal.classList.add('hidden');
            });

            const renderArchiveList = () => {
                viewArchiveListContainer.innerHTML = ''; // Clear previous content
                unarchiveSelectedBtn.disabled = true; // Disable button initially

                const searchTerm = archiveSearchInput.value.toLowerCase();
                const filteredArchived = archivedTasks.filter(task => 
                    task.condominio.toLowerCase().includes(searchTerm)
                );

                if (filteredArchived.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'space-y-2';
                    filteredArchived.sort((a,b) => new Date(b.dataConclusao || b.dataAnalise) - new Date(a.dataConclusao || a.dataAnalise));
                    filteredArchived.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'p-2 bg-white rounded-md text-sm flex justify-between items-center';
                        li.innerHTML = `
                            <label class="flex items-center flex-grow mr-4">
                                <input type="checkbox" value="${task.id}" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 archive-checkbox mr-3">
                                <span><strong>${task.condominio}</strong> - Análise de ${formatDate(task.dataAnalise)}</span>
                            </label>
                            <span class="text-slate-500 text-xs flex-shrink-0">Concluído em: ${formatDate(task.dataConclusao)}</span>
                             <button data-id="${task.id}" class="unarchive-single-btn ml-4 text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded hover:bg-orange-200">Desarquivar</button>
                        `;
                        list.appendChild(li);
                    });
                    viewArchiveListContainer.appendChild(list);
                } else {
                     viewArchiveListContainer.innerHTML = '<p class="text-center text-slate-500">Nenhuma análise arquivada encontrada.</p>';
                }
            };

            viewArchiveBtn.addEventListener('click', () => {
                archiveSearchInput.value = ''; // Limpa a busca
                renderArchiveList(); // Render the list on open
                viewArchiveModal.classList.remove('hidden');
            });

            viewArchiveCloseBtn.addEventListener('click', () => viewArchiveModal.classList.add('hidden'));
            
            archiveSearchInput.addEventListener('input', () => {
                renderArchiveList();
            });

             // Event listener for single unarchive buttons
             viewArchiveListContainer.addEventListener('click', (e) => {
                 if (e.target.classList.contains('archive-checkbox')) {
                      const anyChecked = viewArchiveListContainer.querySelector('.archive-checkbox:checked');
                      unarchiveSelectedBtn.disabled = !anyChecked;
                 }
                
                if (e.target.classList.contains('unarchive-single-btn')) {
                    const taskId = parseInt(e.target.dataset.id);
                    const taskIndex = archivedTasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        const [taskToUnarchive] = archivedTasks.splice(taskIndex, 1);
                        tasks.push(taskToUnarchive);
                        
                        // Re-render a lista de arquivados
                        renderArchiveList();

                        refreshUI(); // Refresh main UI
                        showNotification(`Análise desarquivada.`);
                    }
                }
            });


            unarchiveSelectedBtn.addEventListener('click', () => {
                const selectedIds = Array.from(viewArchiveListContainer.querySelectorAll('.archive-checkbox:checked'))
                                         .map(cb => parseInt(cb.value));
                
                if (selectedIds.length === 0) return;

                let tasksToUnarchive = [];
                let remainingArchived = [];

                archivedTasks.forEach(task => {
                    if (selectedIds.includes(task.id)) {
                        tasksToUnarchive.push(task);
                    } else {
                        remainingArchived.push(task);
                    }
                });

                if (tasksToUnarchive.length > 0) {
                    tasks.push(...tasksToUnarchive);
                    archivedTasks = remainingArchived;
                    renderArchiveList(); // Re-render the archive list
                    refreshUI(); // Refresh main UI
                    
                    // Check if list is now empty and close modal
                    if (archivedTasks.length === 0) {
                         viewArchiveModal.classList.add('hidden');
                    }
                    
                    showNotification(`${tasksToUnarchive.length} análises foram desarquivadas.`);
                }
            });
            
            const renderCategoryList = () => {
                categoryListContainer.innerHTML = '';
                if(categories.length === 0) {
                     categoryListContainer.innerHTML = '<p class="text-center text-slate-500">Nenhuma categoria cadastrada.</p>';
                     return;
                }
                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-white rounded-md';
                    div.innerHTML = `
                        <span class="text-sm">${cat}</span>
                        <button data-category="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none">&times;</button>
                    `;
                    categoryListContainer.appendChild(div);
                });
            };

            categoryBtn.addEventListener('click', () => {
                renderCategoryList();
                categoryModal.classList.remove('hidden');
            });
            categoryCloseBtn.addEventListener('click', () => categoryModal.classList.add('hidden'));

            addCategoryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newCat = newCategoryNameInput.value.trim();
                if (newCat && !categories.includes(newCat)) {
                    categories.push(newCat);
                    saveCategories();
                    renderCategoryList();
                    newCategoryNameInput.value = '';
                }
            });

            categoryListContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-category-btn')) {
                    const catToDelete = e.target.dataset.category;
                    categories = categories.filter(c => c !== catToDelete);
                    saveCategories();
                    renderCategoryList();
                }
            });
            
            plannerBtn.addEventListener('click', () => {
                const nextWeekNumber = getWeekNumber(new Date()) + 1;
                plannerWeekNumberInput.value = nextWeekNumber;
                
                const allTasks = [...tasks, ...archivedTasks];
                const occurrenceMap = allTasks.reduce((acc, task) => {
                    if (!acc[task.condominio]) {
                        acc[task.condominio] = 0;
                    }
                    if (task.ocorrencias && task.ocorrencias.length > 0) {
                        acc[task.condominio] += task.ocorrencias.length;
                    }
                    return acc;
                }, {});

                const rankedCondos = Object.entries(occurrenceMap).sort((a, b) => b[1] - a[1]);
                
                plannerListContainer.innerHTML = '';
                if (rankedCondos.length === 0) {
                    plannerListContainer.innerHTML = '<p class="text-center text-slate-500">Nenhum histórico de ocorrências encontrado para gerar sugestões.</p>';
                    return;
                }

                rankedCondos.forEach(([condominio, count]) => {
                     const label = document.createElement('label');
                     label.className = 'flex items-center p-3 bg-white border rounded-md cursor-pointer';
                     label.innerHTML = `
                        <input type="checkbox" value="${condominio}" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500 planner-checkbox" checked>
                        <span class="ml-3 text-sm font-medium text-slate-700">${condominio}</span>
                        <span class="ml-auto text-xs font-bold text-red-600">${count} ocorr.</span>
                     `;
                     plannerListContainer.appendChild(label);
                });
                
                plannerModal.classList.remove('hidden');
            });
            
            plannerCancelBtn.addEventListener('click', () => {
                plannerModal.classList.add('hidden');
            });

            plannerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const weekNum = parseInt(plannerWeekNumberInput.value);
                if (!weekNum) {
                    showNotification("Por favor, insira um número de semana válido.");
                    return;
                }
                
                const selectedCondos = Array.from(plannerListContainer.querySelectorAll('.planner-checkbox:checked'))
                                             .map(cb => cb.value);
                
                if (selectedCondos.length === 0) {
                     showNotification("Nenhum condomínio foi selecionado.");
                     return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const year = new Date().getFullYear(); // Assumes current year for simplicity
                const mondayOfTaskWeek = getDateOfISOWeek(weekNum, year);
                const dataAnalise = formatDateForInput(mondayOfTaskWeek); // Default to Monday
                let newTasksCount = 0;
                let skippedCount = 0;

                selectedCondos.forEach((condominio, index) => {
                    const isDuplicate = tasks.some(task => 
                        task.condominio === condominio && 
                        task.dataAnalise === dataAnalise &&
                        task.semanaDeTrabalho === weekNum
                    );

                    if (isDuplicate) {
                        skippedCount++;
                        return;
                    }

                     const newTask = {
                        id: Date.now() + index,
                        dataSolicitacao: today,
                        condominio: condominio,
                        dataAnalise: dataAnalise,
                        semanaDeTrabalho: weekNum,
                        statusBackup: 'Pendente',
                        dataBackup: '',
                        statusAnalise: 'Pendente',
                        ocorrencia: null,
                        ocorrencias: [],
                        acao: '',
                        obs: 'Gerado pelo Planejador Semanal',
                        isExpanded: true,
                        dataConclusao: null,
                    };
                    tasks.push(newTask);
                    newTasksCount++;
                });
                
                plannerModal.classList.add('hidden');
                refreshUI();
                showNotification(`${newTasksCount} tarefas geradas para a Semana ${weekNum}. ${skippedCount} duplicadas foram ignoradas.`);
            });


            setupCharts();
            performWeeklyArchive(); // Run weekly archive check on load
            refreshUI(); // Initial render after potential archive
            performAutoBackup(); // Perform auto-backup after initial setup and potential archive
        });
    </script>
</body>
</html>

