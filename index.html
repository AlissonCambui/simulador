<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado Jur√≠dico Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .loading-ring { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .option-label input[type="radio"]:checked + span { background-color: #e0f2f1; border-color: #0d9488; color: #0d9488; }
        .btn-primary { transition: background-color 0.3s, transform 0.1s; }
        .btn-primary:hover { background-color: #047857; transform: translateY(-1px); }
        .btn-secondary { transition: background-color 0.3s, transform 0.1s; }
        .btn-secondary:hover { background-color: #4b5563; transform: translateY(-1px); }
    </style>
</head>
<body class="p-4 sm:p-8 flex justify-center min-h-screen">

    <div id="app" class="w-full max-w-4xl space-y-8">
        <header class="text-center pt-4 pb-2">
            <h1 class="text-4xl font-bold text-gray-800">Simulado Jur√≠dico üß†</h1>
            <p class="text-gray-500 mt-1">Gere 20 quest√µes de Direito usando texto ou arquivos PDF.</p>
        </header>

        <!-- Se√ß√£o de Entrada do Tema e Arquivo -->
        <div id="topic-input-section" class="card p-6 space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">1. Fonte do Simulado</h2>
            
            <!-- Entrada de Arquivo PDF -->
            <div>
                <label for="pdfFile" class="block text-sm font-medium text-gray-700 mb-1">
                    Arquivo PDF (Opcional: use este para criar quest√µes a partir do seu material)
                </label>
                <input type="file" id="pdfFile" accept="application/pdf" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 shadow-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
            </div>

            <!-- Entrada de T√≥pico de Texto -->
            <div>
                <label for="lawTopic" class="block text-sm font-medium text-gray-700 mb-1">
                    T√≥pico de Direito (Obrigat√≥rio, mesmo com PDF)
                </label>
                <input type="text" id="lawTopic" placeholder="Ex: 'Contratos Aleat√≥rios' ou 'Quest√µes sobre o PDF'" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 shadow-sm" required>
            </div>
            
            <button id="generateBtn" class="w-full btn-primary bg-emerald-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-emerald-700 disabled:opacity-50 flex items-center justify-center">
                Gerar 20 Quest√µes
            </button>
            <p class="text-sm text-center text-gray-500 mt-2">O sistema usar√° o PDF (se fornecido) ou apenas o t√≥pico de texto para gerar o simulado.</p>
            <div id="app-message" class="hidden p-2 text-center rounded-lg font-medium"></div>
        </div>

        <!-- Indicador de Carregamento -->
        <div id="loading-indicator" class="card p-6 text-center hidden">
            <div class="flex flex-col items-center justify-center space-y-3">
                <div class="loading-ring"></div>
                <p class="text-gray-600 font-medium">Gerando quest√µes complexas... Analisando material. Aguarde um momento.</p>
                <p class="text-sm text-gray-500">Isso pode levar alguns segundos, pois estamos estruturando o simulado.</p>
            </div>
        </div>

        <!-- Se√ß√£o do Quiz -->
        <div id="quiz-section" class="card p-6 space-y-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">2. Simulado: <span id="quiz-topic" class="text-emerald-600"></span></h2>
            <div id="questions-container" class="space-y-8">
                <!-- Quest√µes ser√£o injetadas aqui -->
            </div>
            
            <!-- Bot√µes de A√ß√£o (Inclui o bot√£o Voltar) -->
            <div class="flex space-x-4">
                <button onclick="resetApp()" class="w-1/3 btn-secondary bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600">
                    Voltar
                </button>
                <button id="submitBtn" class="w-2/3 btn-primary bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50">
                    Finalizar Simulado e Ver Resultado
                </button>
            </div>
        </div>

        <!-- Se√ß√£o de Resultados -->
        <div id="result-section" class="card p-6 space-y-6 hidden">
            <h2 class="text-3xl font-bold text-center" id="result-status"></h2>
            <div class="text-center space-y-1">
                <p class="text-lg text-gray-600">Seu Desempenho:</p>
                <p class="text-5xl font-extrabold" id="score-display"></p>
                <p class="text-sm text-gray-500">M√≠nimo para Aprova√ß√£o: 14/20 (70%)</p>
            </div>

            <div id="review-container" class="space-y-4">
                <h3 class="text-xl font-semibold text-gray-700 border-b pb-2">Revis√£o e Gabarito</h3>
                <!-- Revis√£o ser√° injetada aqui -->
            </div>

            <button onclick="resetApp()" class="w-full btn-primary bg-gray-500 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-gray-600">
                Gerar Novo Simulado
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Vari√°veis globais obrigat√≥rias
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;
        
        // CHAVE DE API DO GEMINI - INSERIDA PARA FUNCIONAR FORA DO CANVAS
        const apiKey = "AIzaSyDOovtBooIqM5RXJEVldmzdbjwCc_xBHpQ"; 
        
        // Inst√¢ncias Firebase
        let app, auth, userId;

        // --- Elementos do DOM ---
        const topicInputSection = document.getElementById('topic-input-section');
        const loadingIndicator = document.getElementById('loading-indicator');
        const quizSection = document.getElementById('quiz-section');
        const resultSection = document.getElementById('result-section');
        const generateBtn = document.getElementById('generateBtn');
        const lawTopicInput = document.getElementById('lawTopic');
        const pdfFileInput = document.getElementById('pdfFile');
        const questionsContainer = document.getElementById('questions-container');
        const submitBtn = document.getElementById('submitBtn');
        const appMessage = document.getElementById('app-message');

        let questionsData = [];
        let userAnswers = {};

        // --- Fun√ß√µes Auxiliares de UI ---

        /** Oculta todas as se√ß√µes e mostra apenas a desejada */
        function showSection(section) {
            topicInputSection.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            quizSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            
            // Remove 'hidden' da se√ß√£o espec√≠fica
            section.classList.remove('hidden');
            
            // Limpa a mensagem de erro/status
            appMessage.classList.add('hidden');
            appMessage.textContent = '';
            appMessage.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
        }

        /** Converte um array de string de op√ß√µes para um objeto mapeado (A: op√ß√£o1, B: op√ß√£o2) */
        function mapOptions(optionsArray) {
            const letters = ['A', 'B', 'C', 'D', 'E'];
            const mapped = {};
            optionsArray.forEach((option, index) => {
                mapped[letters[index]] = option;
            });
            return mapped;
        }

        /** Gera o HTML para um √∫nico bloco de quest√£o */
        function generateQuestionHTML(question, index) {
            const mapped = mapOptions(question.options);
            const questionNumber = index + 1;

            let optionsHTML = '';
            for (const key in mapped) {
                optionsHTML += `
                    <label class="option-label flex items-start space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-150">
                        <input type="radio" name="q${questionNumber}" value="${key}" data-id="${question.id}" 
                                class="mt-1 h-4 w-4 text-emerald-600 border-gray-300 focus:ring-emerald-500"
                                onchange="recordAnswer(${question.id}, '${key}')">
                        <span class="flex-1 text-gray-700 text-sm sm:text-base">${key}) ${mapped[key]}</span>
                    </label>
                `;
            }

            return `
                <div class="question-block p-4 border-b last:border-b-0">
                    <p class="font-semibold text-gray-800 mb-4 text-lg">
                        <span class="text-emerald-600 font-bold mr-2">${questionNumber}.</span> ${question.question}
                    </p>
                    <div class="space-y-2">${optionsHTML}</div>
                </div>
            `;
        }
        
        // --- L√≥gica de Resposta e Armazenamento ---

        window.recordAnswer = (questionId, answerKey) => {
            userAnswers[questionId] = answerKey;
            // Verifica se o bot√£o de finalizar deve ser ativado
            const totalAnswered = Object.keys(userAnswers).length;
            submitBtn.disabled = totalAnswered !== questionsData.length;
        };


        /**
         * L√≥gica de retry com backoff exponencial para chamadas de API.
         */
        async function fetchWithBackoff(url, options, maxRetries = 5, initialDelay = 1000) {
             if (!apiKey) {
                 throw new Error("API Key ausente. Por favor, insira a chave no c√≥digo.");
            }
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.status === 429) {
                        throw new Error("Rate limit exceeded (429)");
                    }
                    
                    // CORRE√á√ÉO CR√çTICA: Verifica erros de autentica√ß√£o (400, 401, 403) e para imediatamente.
                    if (response.status === 400 || response.status === 401 || response.status === 403) {
                         const errorBody = await response.json().catch(() => ({})); 
                         const errorMessage = errorBody.error?.message || `Erro de autentica√ß√£o/permiss√£o. C√≥digo: ${response.status}.`;
                         throw new Error(`API Key Inv√°lida ou Sem Permiss√£o. ${errorMessage} Verifique se a chave est√° correta e se a API Gemini est√° ativada.`);
                    }


                    if (!response.ok) {
                         // Trata outros erros HTTP como falha
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error; // √öltima tentativa falhou, lan√ßa o erro final
                    }
                    const delay = initialDelay * Math.pow(2, attempt) + Math.random() * 500;
                    console.error(`Attempt ${attempt + 1} failed. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        /** Converte um arquivo em Base64 */
        function fileToGenerativePart(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type
                        }
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }


        // --- L√≥gica Principal de Gera√ß√£o de Quest√µes (API) ---

        async function generateQuestions() {
            const topic = lawTopicInput.value.trim();
            const file = pdfFileInput.files[0];

            if (!topic) {
                appMessage.textContent = "O t√≥pico de Direito √© obrigat√≥rio.";
                appMessage.classList.remove('hidden');
                appMessage.classList.add('bg-red-100', 'text-red-700');
                return;
            }

            if (!file && topic.length < 5) {
                 appMessage.textContent = "Por favor, insira um t√≥pico mais descritivo ou carregue um PDF.";
                 appMessage.classList.remove('hidden');
                 appMessage.classList.add('bg-red-100', 'text-red-700');
                 return;
            }

            showSection(loadingIndicator);
            lawTopicInput.disabled = true;
            pdfFileInput.disabled = true;
            generateBtn.disabled = true;

            const userPrompt = file 
                ? `Analise o arquivo PDF fornecido e gere exatamente 20 quest√µes de m√∫ltipla escolha (A-E) de alto n√≠vel sobre o tema: "${topic}", baseadas no conte√∫do do arquivo. Para cada quest√£o, forne√ßa a alternativa correta ("A", "B", "C", "D" ou "E") e uma explica√ß√£o jur√≠dica.`
                : `Gere exatamente 20 quest√µes de m√∫ltipla escolha (A-E) de alto n√≠vel sobre o tema de Direito: "${topic}". Para cada quest√£o, forne√ßa a alternativa correta ("A", "B", "C", "D" ou "E") e uma explica√ß√£o jur√≠dica.`;

            // Construir o array de conte√∫do
            const contentsParts = [{ text: userPrompt }];
            if (file) {
                const filePart = await fileToGenerativePart(file);
                contentsParts.push(filePart);
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = `Voc√™ √© um professor universit√°rio de Direito altamente experiente. Sua √∫nica sa√≠da deve ser um array JSON contendo 20 objetos de quest√£o.`;


            const payload = {
                contents: [{ parts: contentsParts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "id": { "type": "INTEGER" },
                                "question": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "answer": { "type": "STRING" },
                                "explanation": { "type": "STRING" } 
                            },
                            "required": ["id", "question", "options", "answer", "explanation"]
                        }
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) {
                    throw new Error("Resposta da API vazia ou inv√°lida.");
                }

                questionsData = JSON.parse(jsonText);

                if (questionsData.length !== 20) {
                     // Adiciona uma verifica√ß√£o de seguran√ßa, caso a API retorne menos de 20
                     throw new Error(`A API retornou ${questionsData.length} quest√µes. Esperado: 20.`);
                }
                
                // Limpar e popular a UI
                questionsContainer.innerHTML = questionsData.map(generateQuestionHTML).join('');
                document.getElementById('quiz-topic').textContent = topic.toUpperCase();
                submitBtn.disabled = true; // Desabilita at√© todas serem respondidas
                userAnswers = {};
                
                showSection(quizSection);

            } catch (error) {
                console.error("Erro ao gerar quest√µes:", error);
                
                // Feedback de erro para o usu√°rio na tela
                const errorMessage = error.message.includes('API Key Inv√°lida')
                    ? "‚ùå Chave de API Inv√°lida ou a API Gemini n√£o est√° ativada no seu projeto Google Cloud."
                    : `‚ùå Erro ao gerar as quest√µes. Causa: ${error.message}.`;

                appMessage.textContent = errorMessage;
                appMessage.classList.remove('hidden');
                appMessage.classList.add('bg-red-100', 'text-red-700');
                resetApp();
            } finally {
                lawTopicInput.disabled = false;
                pdfFileInput.disabled = false;
                generateBtn.disabled = false;
            }
        }

        // --- L√≥gica de Finaliza√ß√£o e Resultado ---

        function submitQuiz() {
            if (Object.keys(userAnswers).length !== questionsData.length) {
                // Usando UI customizada no lugar de alert()
                appMessage.textContent = "Por favor, responda todas as 20 quest√µes antes de finalizar!";
                appMessage.classList.remove('hidden');
                appMessage.classList.add('bg-red-100', 'text-red-700');
                showSection(quizSection); // Garante que a mensagem seja vista
                return;
            }

            let correctCount = 0;
            const reviewHTML = [];
            const passingScore = 14; // 70% de 20

            questionsData.forEach((q, index) => {
                const userAnswer = userAnswers[q.id];
                const isCorrect = userAnswer === q.answer;

                if (isCorrect) {
                    correctCount++;
                }

                // Cria o bloco de revis√£o
                const reviewItem = `
                    <div class="p-4 rounded-lg ${isCorrect ? 'bg-emerald-50 border border-emerald-300' : 'bg-red-50 border border-red-300'}">
                        <p class="font-semibold text-gray-800">
                            ${index + 1}. ${q.question}
                        </p>
                        <p class="mt-2 text-sm">Sua Resposta: <span class="${isCorrect ? 'text-emerald-600' : 'text-red-600'} font-bold">${userAnswer}</span></p>
                        <p class="text-sm">Resposta Correta: <span class="text-green-700 font-bold">${q.answer}</span></p>
                        <div class="mt-2 p-2 bg-white rounded shadow-sm text-xs text-gray-700">
                            <span class="font-bold">Explica√ß√£o:</span> ${q.explanation}
                        </div>
                    </div>
                `;
                reviewHTML.push(reviewItem);
            });

            // Exibe o resultado
            const resultStatus = document.getElementById('result-status');
            const scoreDisplay = document.getElementById('score-display');
            const resultContainer = document.getElementById('review-container');

            scoreDisplay.textContent = `${correctCount}/20`;
            resultContainer.innerHTML = reviewHTML.join('');

            if (correctCount >= passingScore) {
                resultStatus.textContent = "APROVADO! üéâ";
                resultStatus.classList.remove('text-red-600');
                resultStatus.classList.add('text-green-600');
            } else {
                resultStatus.textContent = "REPROVADO üò•";
                resultStatus.classList.remove('text-green-600');
                resultStatus.classList.add('text-red-600');
            }

            showSection(resultSection);
        }

        // --- L√≥gica de Reinicializa√ß√£o (Geral) ---

        window.resetApp = () => {
            lawTopicInput.value = '';
            pdfFileInput.value = '';
            questionsContainer.innerHTML = '';
            questionsData = [];
            userAnswers = {};
            submitBtn.disabled = true;
            showSection(topicInputSection);
        }
        
        // --- Event Listeners e Inicializa√ß√£o ---

        generateBtn.addEventListener('click', generateQuestions);
        submitBtn.addEventListener('click', submitQuiz);
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Initialization and Auth ---
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            // L√≥gica de autentica√ß√£o mantida para conformidade com o ambiente,
            // mas n√£o afeta o funcionamento do simulado.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                     signInAnonymously(auth).then(res => {
                        userId = res.user.uid;
                     }).catch(err => {
                        console.error("Falha ao fazer login an√¥nimo:", err);
                        userId = 'anonymous_error';
                     });
                }
            });

            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(err => {
                    console.error("Falha no login com Custom Token:", err);
                });
            }
            
             // Iniciar no primeiro passo
             showSection(topicInputSection);
        });

    </script>
</body>
</html>
